<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>MediData Pro - Sistema de Gesti√≥n Cl√≠nica</title>
    
    <!-- Configuraci√≥n PWA -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MediData Pro">
    
    <!-- Librer√≠as -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --light: #f8fafc;
            --dark: #0f172a;
            --gray: #94a3b8;
            --border-radius: 12px;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 16px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 24px 32px;
            color: white;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-title i { font-size: 48px; }
        .header-title h1 { font-size: clamp(24px, 4vw, 32px); font-weight: 700; }

        .stats-grid {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(5px);
            padding: 12px 24px;
            border-radius: var(--border-radius);
            text-align: center;
            min-width: 120px;
            border: 1px solid rgba(255,255,255,0.2);
            cursor: pointer;
            transition: all 0.3s;
        }

        .stat-card:hover { background: rgba(255,255,255,0.25); transform: translateY(-2px); }
        .stat-card span { display: block; font-size: 28px; font-weight: 700; }
        .stat-card label { font-size: 12px; opacity: 0.9; text-transform: uppercase; }

        /* Formulario de registro */
        .form-section {
            padding: 24px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 24px;
            color: var(--dark);
            font-size: 20px;
            font-weight: 600;
        }

        .section-title i { color: var(--primary); }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-weight: 500;
            color: var(--dark);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }

        /* Secci√≥n de Tratamiento - M√öLTIPLES MEDICAMENTOS CON DURACI√ìN */
        .treatment-section {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }

        .treatment-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .treatment-header i { font-size: 24px; color: #d97706; }
        .treatment-header h3 { color: #92400e; font-size: 18px; font-weight: 600; }

        .medicamentos-container {
            margin-bottom: 15px;
        }

        .medicamento-item {
            display: grid;
            grid-template-columns: 2fr 1.5fr 1.5fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .medicamento-nombre {
            grid-column: 1 / 2;
        }

        .medicamento-dosis {
            grid-column: 2 / 3;
        }

        .medicamento-duracion {
            grid-column: 3 / 4;
        }

        .btn-eliminar-medicamento {
            grid-column: 4 / 5;
            background: var(--danger);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .btn-eliminar-medicamento:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .btn-agregar-medicamento {
            background: var(--success);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .btn-agregar-medicamento:hover {
            background: #16a34a;
            transform: translateY(-2px);
        }

        /* Tabs de ex√°menes */
        .examenes-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e2e8f0;
        }

        .examen-tab {
            padding: 10px 20px;
            background: #f1f5f9;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .examen-tab:hover { background: var(--primary); color: white; }
        .examen-tab.active { background: var(--primary); color: white; }

        .examenes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .examen-item {
            background: #f8fafc;
            padding: 12px;
            border-radius: 8px;
        }

        .examen-item label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .examen-item input {
            width: 100%;
            padding: 8px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
        }

        /* Secci√≥n Excel */
        .excel-section {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            padding: 24px;
            color: white;
        }

        .excel-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .excel-header i { font-size: 32px; }
        .excel-header h2 { font-size: 24px; font-weight: 600; }

        .excel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .excel-card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(5px);
            padding: 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .excel-card:hover { background: rgba(255,255,255,0.25); transform: translateY(-4px); }
        .excel-icon { font-size: 32px; margin-bottom: 12px; }
        .excel-card h3 { font-size: 18px; font-weight: 600; }
        .excel-card p { font-size: 13px; opacity: 0.9; margin: 8px 0 16px; }
        .excel-badge {
            display: inline-block;
            padding: 6px 16px;
            background: rgba(255,255,255,0.3);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Buscador de pacientes */
        .buscador-section {
            padding: 24px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
        }

        .buscador-container {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 16px;
            padding: 20px;
            border: 2px solid var(--primary);
        }

        .buscador-titulo {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: var(--primary);
            font-size: 20px;
            font-weight: 600;
        }

        .buscador-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .buscador-input {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            width: 100%;
        }

        .buscador-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }

        .buscador-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Botones */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }

        .btn-icon-small {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-left: 5px;
        }

        /* Tarjeta de informaci√≥n del paciente */
        .paciente-detalle-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 16px;
            margin-top: 20px;
            box-shadow: 0 10px 25px rgba(102,126,234,0.3);
            position: relative;
            overflow: hidden;
        }

        .paciente-detalle-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .paciente-detalle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .paciente-detalle-nombre {
            font-size: 28px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .paciente-detalle-codigo {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 14px;
            font-family: monospace;
        }

        .paciente-detalle-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .paciente-detalle-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 12px;
            backdrop-filter: blur(5px);
        }

        .detalle-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .detalle-value {
            font-size: 20px;
            font-weight: 700;
        }

        .paciente-detalle-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            position: relative;
            z-index: 1;
            margin-top: 20px;
        }

        /* Formulario de edici√≥n */
        .form-edicion {
            background: #f8fafc;
            border-radius: 16px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid var(--primary);
            position: relative;
            z-index: 2;
        }

        .form-edicion-titulo {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: var(--primary);
            font-size: 18px;
            font-weight: 600;
        }

        .form-edicion-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .campo-edicion {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }

        .campo-edicion label {
            display: block;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
            font-size: 14px;
        }

        .campo-edicion .descripcion {
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 8px;
            font-style: italic;
        }

        .campo-edicion input,
        .campo-edicion select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }

        /* Secci√≥n de seguimientos */
        .seguimientos-section {
            padding: 24px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
        }

        .seccion-titulo {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: var(--dark);
            font-size: 20px;
            font-weight: 600;
        }

        .seccion-titulo i { color: var(--success); }

        .seguimientos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .seguimiento-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            border-left: 4px solid var(--success);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .seguimiento-card.nuevo {
            border-left-color: var(--primary);
            background: #f0f9ff;
        }

        .seguimiento-fecha {
            background: var(--gray);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
        }

        .seguimiento-fecha.nuevo {
            background: var(--primary);
        }

        .medicamentos-lista {
            margin-top: 8px;
            padding: 8px;
            background: #f8fafc;
            border-radius: 6px;
        }

        .medicamento-tag {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin: 3px;
            max-width: 100%;
        }

        .medicamento-tag strong {
            font-size: 13px;
        }

        .medicamento-tag small {
            display: block;
            font-size: 10px;
            opacity: 0.9;
            margin-top: 2px;
        }

        /* Secci√≥n de ex√°menes */
        .examenes-section {
            padding: 24px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
        }

        .examenes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .examenes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 16px;
        }

        .examen-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            border: 2px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s;
            cursor: pointer;
        }

        .examen-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }

        .examen-card.selected {
            border: 3px solid var(--primary);
            background: #f0f9ff;
        }

        .examen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .examen-nombre {
            font-weight: 700;
            color: var(--dark);
            font-size: 16px;
        }

        .examen-categoria {
            background: #f1f5f9;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 10px;
            color: var(--secondary);
            font-weight: 600;
        }

        .examen-valor-actual {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            text-align: center;
        }

        .examen-unidad {
            text-align: center;
            color: var(--gray);
            font-size: 14px;
        }

        .examen-fecha {
            text-align: center;
            font-size: 12px;
            color: var(--gray);
            margin: 8px 0;
            font-family: monospace;
        }

        .examen-acciones {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 10px;
        }

        /* Panel de comparaci√≥n de ex√°menes */
        .comparacion-panel {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 30px;
            border: 3px solid var(--primary);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        .comparacion-titulo {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .comparacion-titulo h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
            font-size: 20px;
        }

        .btn-cerrar-comparacion {
            background: var(--gray);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
        }

        .btn-cerrar-comparacion:hover {
            background: var(--danger);
        }

        .comparacion-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            position: relative;
            margin-bottom: 20px;
        }

        .comparacion-grid::before {
            content: "VS";
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: var(--primary);
            color: white;
            padding: 12px 16px;
            border-radius: 50px;
            font-weight: 800;
            font-size: 18px;
            z-index: 10;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            border: 3px solid white;
        }

        .comparacion-columna {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .comparacion-columna.anterior {
            border-top: 6px solid var(--warning);
        }

        .comparacion-columna.nuevo {
            border-top: 6px solid var(--success);
        }

        .comparacion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px dashed #e2e8f0;
        }

        .comparacion-badge {
            padding: 6px 16px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 700;
        }

        .badge-anterior {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-nuevo {
            background: #d1fae5;
            color: #065f46;
        }

        .comparacion-fecha {
            font-size: 13px;
            color: var(--gray);
            font-weight: 500;
            font-family: monospace;
        }

        .comparacion-valor {
            font-size: 48px;
            font-weight: 800;
            text-align: center;
            margin: 20px 0 10px;
        }

        .comparacion-columna.anterior .comparacion-valor {
            color: var(--warning);
        }

        .comparacion-columna.nuevo .comparacion-valor {
            color: var(--success);
        }

        .comparacion-unidad {
            text-align: center;
            color: var(--gray);
            font-size: 16px;
            margin-bottom: 10px;
        }

        .comparacion-diferencia {
            text-align: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
            margin-top: 20px;
            border: 1px solid #e2e8f0;
        }

        .diferencia-label {
            font-size: 13px;
            color: var(--gray);
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .diferencia-valor {
            font-size: 24px;
            font-weight: 700;
        }

        .diferencia-positiva { color: var(--success); }
        .diferencia-negativa { color: var(--danger); }

        .timeline-container {
            margin-top: 30px;
            background: white;
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #e2e8f0;
        }

        .timeline-item {
            display: flex;
            gap: 20px;
            margin-bottom: 12px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 10px;
            align-items: center;
        }

        .timeline-fecha {
            min-width: 180px;
            font-size: 12px;
            color: var(--gray);
            font-family: monospace;
        }

        .timeline-valores {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .timeline-valor-anterior {
            color: var(--warning);
            text-decoration: line-through;
            font-weight: 500;
        }

        .timeline-valor-nuevo {
            color: var(--success);
            font-weight: 700;
        }

        .timeline-cambio-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .cambio-up {
            background: #d1fae5;
            color: #065f46;
        }

        .cambio-down {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e2e8f0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 30px;
            right: 30px;
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 3000;
            border-left: 4px solid var(--success);
        }

        .toast.show { transform: translateX(0); }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--danger); }
        .toast.warning { border-left-color: var(--warning); }

        /* Utilidades */
        .w-100 { width: 100%; }
        .mt-4 { margin-top: 16px; }
        .mb-4 { margin-bottom: 16px; }
        .text-center { text-align: center; }
        .hidden { display: none; }

        @media print {
            body * {
                visibility: hidden;
            }
            #impresion-contenido, #impresion-contenido * {
                visibility: visible;
            }
            #impresion-contenido {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px;
            }
        }

        @media (max-width: 768px) {
            .medicamento-item {
                grid-template-columns: 1fr 1fr;
            }
            
            .medicamento-nombre {
                grid-column: 1 / 3;
            }
            
            .medicamento-dosis {
                grid-column: 1 / 2;
            }
            
            .medicamento-duracion {
                grid-column: 2 / 3;
            }
            
            .btn-eliminar-medicamento {
                grid-column: 1 / 3;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-title">
                    <i class="fas fa-hospital-user"></i>
                    <h1>MediData Pro</h1>
                </div>
                <div class="stats-grid">
                    <div class="stat-card" onclick="filtrarTodos()">
                        <span id="totalPacientes">0</span>
                        <label>Total</label>
                    </div>
                    <div class="stat-card" onclick="filtrarHombres()">
                        <span id="hombresCount">0</span>
                        <label>Hombres</label>
                    </div>
                    <div class="stat-card" onclick="filtrarMujeres()">
                        <span id="mujeresCount">0</span>
                        <label>Mujeres</label>
                    </div>
                    <div class="stat-card">
                        <span id="edadPromedio">0</span>
                        <label>Edad Prom.</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulario de registro de paciente -->
        <div class="form-section">
            <div class="section-title">
                <i class="fas fa-user-plus"></i>
                <h2>Registrar Nuevo Paciente</h2>
            </div>
            <form onsubmit="event.preventDefault(); guardarPacienteCompleto();">
                <div class="form-grid">
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> Nombre *</label>
                        <input type="text" id="nombre" placeholder="Nombre completo" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-calendar"></i> Edad *</label>
                        <input type="number" id="edad" placeholder="Edad" min="0" max="120" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-venus-mars"></i> Sexo *</label>
                        <select id="sexo" required>
                            <option value="">Seleccionar...</option>
                            <option value="Masculino">Masculino</option>
                            <option value="Femenino">Femenino</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-stethoscope"></i> Diagn√≥stico *</label>
                        <input type="text" id="enfermedad" placeholder="Diagn√≥stico principal" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-notes-medical"></i> Observaciones</label>
                        <textarea id="observaciones" placeholder="Notas iniciales..." rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-phone"></i> Tel√©fono</label>
                        <input type="tel" id="telefono" placeholder="Tel√©fono de contacto">
                    </div>
                </div>

                <!-- Tratamiento - M√öLTIPLES MEDICAMENTOS CON DURACI√ìN INDIVIDUAL -->
                <div class="treatment-section">
                    <div class="treatment-header">
                        <i class="fas fa-notes-medical"></i>
                        <h3>Plan de Tratamiento - Medicamentos</h3>
                    </div>
                    
                    <p style="margin-bottom: 15px; color: #92400e;"><i class="fas fa-info-circle"></i> Cada medicamento puede tener su propia duraci√≥n de tratamiento</p>
                    
                    <!-- Contenedor de medicamentos -->
                    <div id="medicamentosContainer" class="medicamentos-container">
                        <!-- Los medicamentos se agregar√°n aqu√≠ din√°micamente -->
                    </div>
                    
                    <button type="button" class="btn-agregar-medicamento" onclick="agregarMedicamento()">
                        <i class="fas fa-plus-circle"></i> Agregar otro medicamento
                    </button>
                    
                    <div class="form-grid" style="margin-top: 15px;">
                        <div class="form-group">
                            <label><i class="fas fa-clipboard-list"></i> Indicaciones generales</label>
                            <textarea id="indicaciones" placeholder="Instrucciones adicionales para todos los medicamentos..." rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-calendar-check"></i> Pr√≥xima cita de control</label>
                            <input type="date" id="proximaCita">
                        </div>
                    </div>
                </div>

                <!-- Ex√°menes de ingreso -->
                <div class="section-title">
                    <i class="fas fa-flask"></i>
                    <h2>Ex√°menes de Ingreso</h2>
                </div>

                <div class="examenes-tabs">
                    <button class="examen-tab active" type="button" onclick="cambiarCategoria('hematologia', this)">Hematolog√≠a</button>
                    <button class="examen-tab" type="button" onclick="cambiarCategoria('quimica', this)">Qu√≠mica</button>
                    <button class="examen-tab" type="button" onclick="cambiarCategoria('hierro', this)">Vitaminas</button>
                    <button class="examen-tab" type="button" onclick="cambiarCategoria('hepatica', this)">Hep√°tica</button>
                    <button class="examen-tab" type="button" onclick="cambiarCategoria('especiales', this)">Especiales</button>
                    <button class="examen-tab" type="button" onclick="cambiarCategoria('otros', this)">Otros</button>
                </div>

                <div id="hematologia" class="examenes-grid"></div>
                <div id="quimica" class="examenes-grid" style="display:none;"></div>
                <div id="hierro" class="examenes-grid" style="display:none;"></div>
                <div id="hepatica" class="examenes-grid" style="display:none;"></div>
                <div id="especiales" class="examenes-grid" style="display:none;"></div>
                <div id="otros" class="examenes-grid" style="display:none;"></div>

                <button type="submit" class="btn btn-primary w-100 mt-4">
                    <i class="fas fa-save"></i> GUARDAR PACIENTE
                </button>
            </form>
        </div>

        <!-- Secci√≥n Excel -->
        <div class="excel-section">
            <div class="excel-header">
                <i class="fas fa-file-excel"></i>
                <h2>Exportar a Excel</h2>
            </div>
            <div class="excel-grid">
                <div class="excel-card" onclick="exportarExcelCompleto()">
                    <div class="excel-icon"><i class="fas fa-database"></i></div>
                    <h3>Completo</h3>
                    <p>Todos los pacientes</p>
                    <span class="excel-badge">Exportar</span>
                </div>
                <div class="excel-card" onclick="exportarExcelResumen()">
                    <div class="excel-icon"><i class="fas fa-chart-pie"></i></div>
                    <h3>Resumen</h3>
                    <p>Estad√≠sticas generales</p>
                    <span class="excel-badge">Exportar</span>
                </div>
                <div class="excel-card" onclick="exportarExcelPacienteIndividual()">
                    <div class="excel-icon"><i class="fas fa-user-md"></i></div>
                    <h3>Paciente Individual</h3>
                    <p>Historial completo por paciente</p>
                    <span class="excel-badge">Exportar</span>
                </div>
            </div>
        </div>

        <!-- Buscador de pacientes -->
        <div class="buscador-section">
            <div class="buscador-container">
                <div class="buscador-titulo">
                    <i class="fas fa-search"></i>
                    <h3>Buscar Paciente</h3>
                </div>
                <div class="buscador-grid">
                    <input type="text" id="buscarNombre" class="buscador-input" placeholder="Buscar por nombre...">
                    <input type="text" id="buscarCodigo" class="buscador-input" placeholder="Buscar por c√≥digo...">
                    <button class="btn btn-primary" onclick="buscarPaciente()">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                </div>
                <div class="buscador-buttons">
                    <button class="btn btn-info" onclick="exportarExcelPacienteActual()" id="btnExportarPaciente" style="display:none;">
                        <i class="fas fa-file-excel"></i> Exportar Historial
                    </button>
                    <button class="btn btn-warning" onclick="imprimirHistorialPaciente()" id="btnImprimirPaciente" style="display:none;">
                        <i class="fas fa-print"></i> Imprimir Historial
                    </button>
                    <button class="btn btn-secondary" onclick="limpiarBusqueda()" id="btnCancelarBusqueda" style="display:none;">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>

                <!-- Resultado de la b√∫squeda - Datos generales del paciente -->
                <div id="resultadoBusqueda" style="display:none;">
                    <div class="paciente-detalle-card">
                        <div class="paciente-detalle-header">
                            <div class="paciente-detalle-nombre">
                                <i class="fas fa-user-circle"></i>
                                <span id="detalleNombre"></span>
                            </div>
                            <span class="paciente-detalle-codigo" id="detalleCodigo"></span>
                        </div>
                        
                        <div class="paciente-detalle-grid">
                            <div class="paciente-detalle-item">
                                <div class="detalle-label">EDAD</div>
                                <div class="detalle-value" id="detalleEdad"></div>
                            </div>
                            <div class="paciente-detalle-item">
                                <div class="detalle-label">SEXO</div>
                                <div class="detalle-value" id="detalleSexo"></div>
                            </div>
                            <div class="paciente-detalle-item">
                                <div class="detalle-label">DIAGN√ìSTICO</div>
                                <div class="detalle-value" id="detalleDiagnostico"></div>
                            </div>
                            <div class="paciente-detalle-item">
                                <div class="detalle-label">TEL√âFONO</div>
                                <div class="detalle-value" id="detalleTelefono"></div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div class="paciente-detalle-item">
                                <div class="detalle-label">MEDICAMENTOS</div>
                                <div class="detalle-value" id="detalleMedicamentos"></div>
                            </div>
                            <div class="paciente-detalle-item">
                                <div class="detalle-label">FECHA REGISTRO</div>
                                <div class="detalle-value" id="detalleFechaRegistro"></div>
                            </div>
                        </div>

                        <div class="paciente-detalle-actions">
                            <button class="btn btn-warning" onclick="mostrarFormularioEdicion()">
                                <i class="fas fa-edit"></i> Editar Datos
                            </button>
                        </div>

                        <!-- Formulario de edici√≥n -->
                        <div id="formularioEdicion" class="form-edicion" style="display:none;">
                            <div class="form-edicion-titulo">
                                <i class="fas fa-edit"></i>
                                <h4>Editar Datos del Paciente</h4>
                            </div>
                            <div class="form-edicion-grid">
                                <div class="campo-edicion">
                                    <label>üë§ Nombre Completo</label>
                                    <div class="descripcion">Nombre completo del paciente (obligatorio)</div>
                                    <input type="text" id="editNombre" placeholder="Ej: Juan P√©rez Garc√≠a">
                                </div>
                                
                                <div class="campo-edicion">
                                    <label>üìÖ Edad</label>
                                    <div class="descripcion">Edad en a√±os (obligatorio)</div>
                                    <input type="number" id="editEdad" min="0" max="120" placeholder="Ej: 45">
                                </div>
                                
                                <div class="campo-edicion">
                                    <label>‚ö• Sexo</label>
                                    <div class="descripcion">G√©nero del paciente (obligatorio)</div>
                                    <select id="editSexo">
                                        <option value="Masculino">Masculino</option>
                                        <option value="Femenino">Femenino</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </div>
                                
                                <div class="campo-edicion">
                                    <label>üè• Diagn√≥stico</label>
                                    <div class="descripcion">Diagn√≥stico principal o enfermedad (obligatorio)</div>
                                    <input type="text" id="editDiagnostico" placeholder="Ej: Hipertensi√≥n arterial">
                                </div>
                                
                                <div class="campo-edicion">
                                    <label>üìû Tel√©fono</label>
                                    <div class="descripcion">N√∫mero de contacto (opcional)</div>
                                    <input type="text" id="editTelefono" placeholder="Ej: +34 600 123 456">
                                </div>
                            </div>
                            
                            <!-- Secci√≥n de medicamentos en edici√≥n -->
                            <div class="campo-edicion" style="grid-column: span 2;">
                                <label>üíä Medicamentos (cada uno con su duraci√≥n)</label>
                                <div class="descripcion">Puede agregar m√∫ltiples medicamentos, cada uno con su propia duraci√≥n</div>
                                <div id="editMedicamentosContainer" class="medicamentos-container"></div>
                                <button type="button" class="btn-agregar-medicamento" onclick="agregarMedicamentoEdicion()">
                                    <i class="fas fa-plus-circle"></i> Agregar otro medicamento
                                </button>
                            </div>
                            
                            <div class="campo-edicion">
                                <label>üìÖ Pr√≥xima Cita de Control</label>
                                <div class="descripcion">Fecha de la pr√≥xima consulta general</div>
                                <input type="date" id="editProximaCita">
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; grid-column: span 2;">
                                <button class="btn btn-secondary" onclick="cancelarEdicion()">Cancelar</button>
                                <button class="btn btn-success" onclick="guardarEdicionPaciente()">Guardar Cambios</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n de Seguimientos -->
        <div class="seguimientos-section" id="seguimientosSection" style="display:none;">
            <div class="seccion-titulo">
                <i class="fas fa-history"></i>
                <h3>Historial de Seguimientos - <span id="seguimientosPacienteNombre"></span></h3>
            </div>
            
            <button class="btn btn-success" onclick="mostrarFormularioSeguimiento()" style="margin-bottom: 20px;">
                <i class="fas fa-plus-circle"></i> Nuevo Seguimiento
            </button>

            <!-- Formulario de nuevo seguimiento -->
            <div id="formularioSeguimiento" style="display: none; margin-bottom: 20px; background: #f8fafc; padding: 20px; border-radius: 12px; border: 2px solid var(--success);">
                <h4 style="margin-bottom: 15px; color: var(--success);">
                    <i class="fas fa-notes-medical"></i> Nuevo Seguimiento
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div>
                        <label>Fecha del seguimiento</label>
                        <input type="date" id="nuevoSeguimientoFecha" class="buscador-input">
                    </div>
                    <div>
                        <label>Diagn√≥stico actual</label>
                        <input type="text" id="nuevoSeguimientoDiagnostico" class="buscador-input" placeholder="Diagn√≥stico actual">
                    </div>
                    <div style="grid-column: span 2;">
                        <label>Medicamentos (cada uno con su duraci√≥n)</label>
                        <div id="nuevoSeguimientoMedicamentosContainer" class="medicamentos-container"></div>
                        <button type="button" class="btn-agregar-medicamento" onclick="agrpZEAWYtiB6bJ16NuLbGCc6CZ6jJdKfb63()">
                            <i class="fas fa-plus-circle"></i> Agregar medicamento
                        </button>
                    </div>
                    <div>
                        <label>Evoluci√≥n del paciente</label>
                        <textarea id="nuevoSeguimientoEvolucion" class="buscador-input" rows="3" placeholder="Evoluci√≥n del paciente..."></textarea>
                    </div>
                    <div>
                        <label>Nuevos ex√°menes realizados</label>
                        <textarea id="nuevoSeguimientoExamenes" class="buscador-input" rows="3" placeholder="Resultados de ex√°menes..."></textarea>
                    </div>
                    <div>
                        <label>Pr√≥xima cita de control</label>
                        <input type="date" id="nuevoSeguimientoProximaCita" class="buscador-input">
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="ocultarFormularioSeguimiento()">Cancelar</button>
                    <button class="btn btn-success" onclick="guardarNuevoSeguimiento()">Guardar Seguimiento</button>
                </div>
            </div>

            <div class="seguimientos-grid" id="seguimientosGrid"></div>
        </div>

        <!-- Secci√≥n de Ex√°menes -->
        <div class="examenes-section" id="examenesSection" style="display:none;">
            <div class="examenes-header">
                <div class="seccion-titulo">
                    <i class="fas fa-flask"></i>
                    <h3>Ex√°menes M√©dicos - <span id="examenesPacienteNombre"></span></h3>
                </div>
                <div>
                    <button class="btn btn-info" onclick="cerrarComparacionExamen()" id="btnCerrarComparacion" style="display:none; margin-right:10px;">
                        <i class="fas fa-times"></i> Cerrar Comparaci√≥n
                    </button>
                    <button class="btn btn-success" onclick="mostrarModalNuevoExamen()">
                        <i class="fas fa-plus-circle"></i> Nuevo Examen
                    </button>
                </div>
            </div>

            <!-- Panel de comparaci√≥n de ex√°menes -->
            <div id="comparacionExamenPanel" class="comparacion-panel" style="display:none;"></div>

            <div class="examenes-grid" id="examenesGrid"></div>
        </div>

        <!-- Contenido oculto para impresi√≥n -->
        <div id="impresion-contenido" style="display:none;"></div>
    </div>

    <!-- Modal para exportar paciente individual -->
    <div class="modal" id="modalExportarPaciente">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-file-excel"></i> Exportar Paciente</h2>
                <button class="modal-close" onclick="cerrarModalExportar()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px;">Ingrese el nombre o c√≥digo del paciente que desea exportar:</p>
                <input type="text" id="exportarPacienteInput" class="buscador-input" placeholder="Nombre o c√≥digo del paciente" style="margin-bottom: 15px;">
                <div id="resultadoExportar" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModalExportar()">Cancelar</button>
                <button class="btn btn-success" onclick="exportarPacienteSeleccionado()" id="btnConfirmarExportar" style="display:none;">Exportar</button>
            </div>
        </div>
    </div>

    <!-- Modal para editar/agregar examen -->
    <div class="modal" id="modalExamen">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalExamenTitulo"><i class="fas fa-flask"></i> Examen</h2>
                <button class="modal-close" onclick="cerrarModalExamen()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Tipo de Examen</label>
                    <select id="examenSelect" class="buscador-input">
                        <option value="">-- Seleccione --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Valor / Resultado</label>
                    <input type="text" id="examenValor" class="buscador-input" placeholder="Ingrese el valor">
                </div>
                <div class="form-group">
                    <label>Unidad de medida</label>
                    <input type="text" id="examenUnidad" class="buscador-input" readonly>
                </div>
                <div class="form-group">
                    <label>Fecha del Examen</label>
                    <input type="date" id="examenFecha" class="buscador-input">
                </div>
                <div class="form-group">
                    <label>Hora (opcional)</label>
                    <input type="time" id="examenHora" class="buscador-input">
                </div>
                <small style="color: var(--gray);">Si no especifica hora, se usar√° la hora actual</small>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModalExamen()">Cancelar</button>
                <button class="btn btn-success" onclick="guardarExamen()" id="btnGuardarExamen">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <div class="toast-icon"><i class="fas fa-check-circle"></i></div>
        <div class="toast-content">
            <div class="toast-title" id="toastTitle">√âxito</div>
            <div class="toast-message" id="toastMessage"></div>
        </div>
        <button class="toast-close" onclick="cerrarToast()">&times;</button>
    </div>

    <script>
        // ==================== CONFIGURACI√ìN ====================
        let pacientes = [];
        let pacienteActual = null;
        let pacienteSeleccionadoExportar = null;
        let examenSeleccionadoId = null;
        let indiceExamenEditando = null;

        // Contador para IDs √∫nicos de medicamentos
        let medicamentoCounter = 0;

        // Lista de ex√°menes
        const examenesLista = [
            { id: 'hemoglobina', nombre: 'Hemoglobina', categoria: 'hematologia', unidad: 'g/dL' },
            { id: 'leucocitos', nombre: 'Leucocitos', categoria: 'hematologia', unidad: 'x10¬≥/¬µL' },
            { id: 'neutrofilos', nombre: 'Neutr√≥filos', categoria: 'hematologia', unidad: '%' },
            { id: 'linfocitos', nombre: 'Linfocitos', categoria: 'hematologia', unidad: '%' },
            { id: 'plaquetas', nombre: 'Plaquetas', categoria: 'hematologia', unidad: 'x10¬≥/¬µL' },
            { id: 'creatinina', nombre: 'Creatinina', categoria: 'quimica', unidad: 'mg/dL' },
            { id: 'bun', nombre: 'BUN', categoria: 'quimica', unidad: 'mg/dL' },
            { id: 'urea', nombre: 'Urea', categoria: 'quimica', unidad: 'mg/dL' },
            { id: 'ferritina', nombre: 'Ferritina', categoria: 'hierro', unidad: 'ng/mL' },
            { id: 'hierro', nombre: 'Hierro s√©rico', categoria: 'hierro', unidad: '¬µg/dL' },
            { id: 'b12', nombre: 'Vitamina B12', categoria: 'hierro', unidad: 'pg/mL' },
            { id: 'tgo', nombre: 'TGO', categoria: 'hepatica', unidad: 'U/L' },
            { id: 'tgp', nombre: 'TGP', categoria: 'hepatica', unidad: 'U/L' },
            { id: 'bmo', nombre: 'BMO', categoria: 'especiales', unidad: '' },
            { id: 'eritropoyetina', nombre: 'Eritropoyetina', categoria: 'especiales', unidad: 'mU/mL' },
            { id: 'ultrasonido', nombre: 'Ultrasonido', categoria: 'otros', unidad: '' },
            { id: 'tac', nombre: 'TAC', categoria: 'otros', unidad: '' }
        ];

        // ==================== FUNCI√ìN PARA FORMATEAR FECHA ====================
        function formatearFecha(fechaISO, hora) {
            const fecha = new Date(fechaISO);
            if (hora) {
                const [horas, minutos] = hora.split(':');
                fecha.setHours(parseInt(horas), parseInt(minutos), 0, 0);
            }
            
            const opciones = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            };
            
            return fecha.toLocaleString('es-ES', opciones);
        }

        // ==================== FUNCIONES PARA MEDICAMENTOS CON DURACI√ìN ====================
        function agregarMedicamento(nombre = '', dosis = '', duracion = '', containerId = 'medicamentosContainer') {
            const container = document.getElementById(containerId);
            const id = `med_${Date.now()}_${medicamentoCounter++}`;
            
            const div = document.createElement('div');
            div.className = 'medicamento-item';
            div.id = id;
            div.innerHTML = `
                <input type="text" class="medicamento-nombre buscador-input" placeholder="Nombre del medicamento (ej: Paracetamol)" value="${nombre}">
                <input type="text" class="medicamento-dosis buscador-input" placeholder="Dosis (ej: 500mg c/8h)" value="${dosis}">
                <input type="text" class="medicamento-duracion buscador-input" placeholder="Duraci√≥n (ej: 7 d√≠as, 3 meses)" value="${duracion}">
                <button type="button" class="btn-eliminar-medicamento" onclick="eliminarMedicamento('${id}')">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            
            container.appendChild(div);
        }

        function eliminarMedicamento(id) {
            document.getElementById(id)?.remove();
        }

        function obtenerMedicamentos(containerId = 'medicamentosContainer') {
            const container = document.getElementById(containerId);
            const items = container.querySelectorAll('.medicamento-item');
            const medicamentos = [];
            
            items.forEach(item => {
                const nombre = item.querySelector('.medicamento-nombre')?.value.trim();
                const dosis = item.querySelector('.medicamento-dosis')?.value.trim();
                const duracion = item.querySelector('.medicamento-duracion')?.value.trim();
                
                if (nombre) {
                    medicamentos.push({
                        nombre: nombre,
                        dosis: dosis || 'Sin especificar',
                        duracion: duracion || 'No especificada'
                    });
                }
            });
            
            return medicamentos;
        }

        function mostrarMedicamentos(medicamentos, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = '';
            if (medicamentos && medicamentos.length > 0) {
                medicamentos.forEach(med => {
                    agregarMedicamento(med.nombre, med.dosis, med.duracion, containerId);
                });
            } else {
                // Agregar un medicamento vac√≠o por defecto
                agregarMedicamento('', '', '', containerId);
            }
        }

        // ==================== INICIALIZACI√ìN ====================
        document.addEventListener('DOMContentLoaded', () => {
            cargarPacientes();
            generarCamposExamenes();
            cargarSelectExamenes();
            actualizarEstadisticas();
            
            // Agregar un medicamento por defecto en el registro
            agregarMedicamento();
        });

        function cargarPacientes() {
            const stored = localStorage.getItem('medidata_completo_v8');
            pacientes = stored ? JSON.parse(stored) : [];
            
            // Asegurar que todos los pacientes tengan el array de medicamentos con duraci√≥n
            pacientes.forEach(paciente => {
                if (!paciente.medicamentos) {
                    paciente.medicamentos = [];
                }
                // Asegurar que cada medicamento tenga campo duracion
                paciente.medicamentos.forEach(med => {
                    if (!med.duracion) {
                        med.duracion = 'No especificada';
                    }
                });
            });
        }

        function guardarPacientes() {
            localStorage.setItem('medidata_completo_v8', JSON.stringify(pacientes));
            actualizarEstadisticas();
        }

        function generarCamposExamenes() {
            const categorias = ['hematologia', 'quimica', 'hierro', 'hepatica', 'especiales', 'otros'];
            
            categorias.forEach(cat => {
                const container = document.getElementById(cat);
                if (!container) return;
                
                const examenesCat = examenesLista.filter(e => e.categoria === cat);
                let html = '';
                
                examenesCat.forEach(ex => {
                    html += `
                        <div class="examen-item">
                            <label>${ex.nombre} (${ex.unidad})</label>
                            <input type="text" id="examen_${ex.id}" placeholder="Valor">
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            });
        }

        function cargarSelectExamenes() {
            const select = document.getElementById('examenSelect');
            let html = '<option value="">-- Seleccione --</option>';
            
            examenesLista.forEach(ex => {
                html += `<option value="${ex.id}" data-unidad="${ex.unidad}">${ex.nombre} (${ex.categoria})</option>`;
            });
            
            select.innerHTML = html;
            
            select.addEventListener('change', function() {
                const opt = this.options[this.selectedIndex];
                document.getElementById('examenUnidad').value = opt.dataset.unidad || '';
            });
        }

        function actualizarEstadisticas() {
            document.getElementById('totalPacientes').textContent = pacientes.length;
            
            let hombres = 0, mujeres = 0, sumaEdad = 0;
            pacientes.forEach(p => {
                if (p.sexo === 'Masculino') hombres++;
                else if (p.sexo === 'Femenino') mujeres++;
                sumaEdad += p.edad;
            });
            
            document.getElementById('hombresCount').textContent = hombres;
            document.getElementById('mujeresCount').textContent = mujeres;
            document.getElementById('edadPromedio').textContent = pacientes.length > 0 ? (sumaEdad / pacientes.length).toFixed(1) : 0;
        }

        // ==================== REGISTRO DE PACIENTE ====================
        function generarCodigo() {
            const num = String(pacientes.length + 1).padStart(4, '0');
            const fecha = new Date();
            return `PAC-${fecha.getFullYear().toString().slice(-2)}${String(fecha.getMonth()+1).padStart(2,'0')}${String(fecha.getDate()).padStart(2,'0')}-${num}`;
        }

        function guardarPacienteCompleto() {
            const nombre = document.getElementById('nombre').value.trim();
            const edad = document.getElementById('edad').value;
            const sexo = document.getElementById('sexo').value;
            const enfermedad = document.getElementById('enfermedad').value.trim();

            if (!nombre || !edad || !sexo || !enfermedad) {
                mostrarToast('error', 'Error', 'Complete los campos obligatorios');
                return;
            }

            const medicamentos = obtenerMedicamentos('medicamentosContainer');

            const examenesPaciente = [];
            examenesLista.forEach(ex => {
                const input = document.getElementById(`examen_${ex.id}`);
                if (input && input.value.trim()) {
                    const ahora = new Date();
                    const fechaISO = ahora.toISOString();
                    const fechaFormateada = formatearFecha(fechaISO, null);
                    
                    examenesPaciente.push({
                        id: ex.id,
                        nombre: ex.nombre,
                        categoria: ex.categoria,
                        valor: input.value.trim(),
                        unidad: ex.unidad,
                        fecha: fechaFormateada,
                        fechaISO: fechaISO,
                        hora: null,
                        fechaFormateada: fechaFormateada,
                        historial: []
                    });
                }
            });

            const nuevoPaciente = {
                codigo: generarCodigo(),
                nombre: nombre,
                edad: parseInt(edad),
                sexo: sexo,
                enfermedad: enfermedad,
                observaciones: document.getElementById('observaciones').value.trim() || 'Sin observaciones',
                telefono: document.getElementById('telefono').value.trim() || 'No especificado',
                medicamentos: medicamentos,
                tratamiento: {
                    indicaciones: document.getElementById('indicaciones').value.trim() || 'Sin indicaciones',
                    proximaCita: document.getElementById('proximaCita').value || 'No programada'
                },
                examenes: examenesPaciente,
                seguimientos: [],
                fechaRegistro: new Date().toISOString()
            };

            pacientes.push(nuevoPaciente);
            guardarPacientes();
            limpiarFormulario();
            mostrarToast('success', 'Paciente registrado', `C√≥digo: ${nuevoPaciente.codigo}`);
        }

        function limpiarFormulario() {
            document.getElementById('nombre').value = '';
            document.getElementById('edad').value = '';
            document.getElementById('sexo').value = '';
            document.getElementById('enfermedad').value = '';
            document.getElementById('observaciones').value = '';
            document.getElementById('telefono').value = '';
            document.getElementById('indicaciones').value = '';
            document.getElementById('proximaCita').value = '';
            
            // Limpiar medicamentos
            document.getElementById('medicamentosContainer').innerHTML = '';
            agregarMedicamento(); // Agregar uno por defecto
            
            examenesLista.forEach(ex => {
                const input = document.getElementById(`examen_${ex.id}`);
                if (input) input.value = '';
            });
        }

        function cambiarCategoria(cat, btn) {
            document.querySelectorAll('.examen-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.examenes-grid').forEach(g => g.style.display = 'none');
            btn.classList.add('active');
            document.getElementById(cat).style.display = 'grid';
        }

        // ==================== BUSCADOR ====================
        function buscarPaciente() {
            const nombre = document.getElementById('buscarNombre').value.toLowerCase().trim();
            const codigo = document.getElementById('buscarCodigo').value.toLowerCase().trim();

            if (!nombre && !codigo) {
                mostrarToast('warning', 'Ingrese datos', 'Escriba un nombre o c√≥digo para buscar');
                return;
            }

            let pacienteEncontrado = null;

            if (codigo) {
                pacienteEncontrado = pacientes.find(p => p.codigo.toLowerCase() === codigo);
            } else if (nombre) {
                pacienteEncontrado = pacientes.find(p => p.nombre.toLowerCase().includes(nombre));
            }

            if (!pacienteEncontrado) {
                mostrarToast('error', 'No encontrado', 'No se encontr√≥ ning√∫n paciente con esos datos');
                limpiarBusqueda();
                return;
            }

            pacienteActual = pacienteEncontrado;
            mostrarDatosPaciente(pacienteActual);
            mostrarSeguimientosPaciente(pacienteActual);
            mostrarExamenesPaciente(pacienteActual);
            
            document.getElementById('btnExportarPaciente').style.display = 'inline-flex';
            document.getElementById('btnImprimirPaciente').style.display = 'inline-flex';
            document.getElementById('btnCancelarBusqueda').style.display = 'inline-flex';
            document.getElementById('resultadoBusqueda').style.display = 'block';
            document.getElementById('seguimientosSection').style.display = 'block';
            document.getElementById('examenesSection').style.display = 'block';
            
            document.getElementById('buscarNombre').value = '';
            document.getElementById('buscarCodigo').value = '';
        }

        function limpiarBusqueda() {
            pacienteActual = null;
            examenSeleccionadoId = null;
            document.getElementById('resultadoBusqueda').style.display = 'none';
            document.getElementById('seguimientosSection').style.display = 'none';
            document.getElementById('examenesSection').style.display = 'none';
            document.getElementById('btnExportarPaciente').style.display = 'none';
            document.getElementById('btnImprimirPaciente').style.display = 'none';
            document.getElementById('btnCancelarBusqueda').style.display = 'none';
            document.getElementById('formularioEdicion').style.display = 'none';
            document.getElementById('comparacionExamenPanel').style.display = 'none';
            document.getElementById('btnCerrarComparacion').style.display = 'none';
        }

        function mostrarDatosPaciente(paciente) {
            document.getElementById('detalleNombre').textContent = paciente.nombre;
            document.getElementById('detalleCodigo').textContent = paciente.codigo;
            document.getElementById('detalleEdad').textContent = paciente.edad + ' a√±os';
            
            let sexoIcon = '';
            if (paciente.sexo === 'Masculino') sexoIcon = '‚ôÇÔ∏è';
            else if (paciente.sexo === 'Femenino') sexoIcon = '‚ôÄÔ∏è';
            else sexoIcon = '‚öß';
            document.getElementById('detalleSexo').innerHTML = `${sexoIcon} ${paciente.sexo}`;
            
            document.getElementById('detalleDiagnostico').textContent = paciente.enfermedad;
            document.getElementById('detalleTelefono').textContent = paciente.telefono || 'No especificado';
            
            // Mostrar medicamentos con duraci√≥n
            if (paciente.medicamentos && paciente.medicamentos.length > 0) {
                let medicamentosHtml = '<div class="medicamentos-lista">';
                paciente.medicamentos.forEach(med => {
                    medicamentosHtml += `
                        <span class="medicamento-tag">
                            <strong>${med.nombre}</strong><br>
                            <small>${med.dosis} | Duraci√≥n: ${med.duracion}</small>
                        </span> 
                    `;
                });
                medicamentosHtml += '</div>';
                document.getElementById('detalleMedicamentos').innerHTML = medicamentosHtml;
            } else {
                document.getElementById('detalleMedicamentos').innerHTML = 'No hay medicamentos recetados';
            }
            
            document.getElementById('detalleFechaRegistro').textContent = new Date(paciente.fechaRegistro).toLocaleDateString();
            
            document.getElementById('seguimientosPacienteNombre').textContent = paciente.nombre;
            document.getElementById('examenesPacienteNombre').textContent = paciente.nombre;
        }

        // ==================== EDICI√ìN DE PACIENTE ====================
        function mostrarFormularioEdicion() {
            if (!pacienteActual) {
                mostrarToast('error', 'Error', 'No hay paciente seleccionado');
                return;
            }
            
            // Llenar el formulario con los datos actuales
            document.getElementById('editNombre').value = pacienteActual.nombre || '';
            document.getElementById('editEdad').value = pacienteActual.edad || '';
            document.getElementById('editSexo').value = pacienteActual.sexo || 'Masculino';
            document.getElementById('editDiagnostico').value = pacienteActual.enfermedad || '';
            document.getElementById('editTelefono').value = pacienteActual.telefono || '';
            document.getElementById('editProximaCita').value = (pacienteActual.tratamiento && pacienteActual.tratamiento.proximaCita) || '';
            
            // Mostrar medicamentos con duraci√≥n
            mostrarMedicamentos(pacienteActual.medicamentos || [], 'editMedicamentosContainer');
            
            // Mostrar el formulario
            document.getElementById('formularioEdicion').style.display = 'block';
            
            // Scroll suave al formulario
            document.getElementById('formularioEdicion').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function cancelarEdicion() {
            document.getElementById('formularioEdicion').style.display = 'none';
        }

        function guardarEdicionPaciente() {
            if (!pacienteActual) {
                mostrarToast('error', 'Error', 'No hay paciente seleccionado');
                return;
            }
            
            // Obtener los valores del formulario
            const nuevoNombre = document.getElementById('editNombre').value.trim();
            const nuevaEdad = document.getElementById('editEdad').value;
            const nuevoSexo = document.getElementById('editSexo').value;
            const nuevoDiagnostico = document.getElementById('editDiagnostico').value.trim();
            const nuevoTelefono = document.getElementById('editTelefono').value.trim();
            const nuevaProximaCita = document.getElementById('editProximaCita').value;
            
            // Validar campos obligatorios
            if (!nuevoNombre || !nuevaEdad || !nuevoSexo || !nuevoDiagnostico) {
                mostrarToast('error', 'Error', 'Los campos Nombre, Edad, Sexo y Diagn√≥stico son obligatorios');
                return;
            }
            
            // Obtener medicamentos con duraci√≥n
            const medicamentos = obtenerMedicamentos('editMedicamentosContainer');
            
            // Actualizar los datos del paciente
            pacienteActual.nombre = nuevoNombre;
            pacienteActual.edad = parseInt(nuevaEdad);
            pacienteActual.sexo = nuevoSexo;
            pacienteActual.enfermedad = nuevoDiagnostico;
            pacienteActual.telefono = nuevoTelefono;
            pacienteActual.medicamentos = medicamentos;
            
            // Actualizar tratamiento
            if (!pacienteActual.tratamiento) {
                pacienteActual.tratamiento = {};
            }
            pacienteActual.tratamiento.proximaCita = nuevaProximaCita || 'No programada';
            
            // Actualizar fecha de modificaci√≥n
            pacienteActual.ultimaActualizacion = new Date().toISOString();
            
            // Guardar en localStorage
            guardarPacientes();
            
            // Actualizar la vista
            mostrarDatosPaciente(pacienteActual);
            
            // Ocultar el formulario
            document.getElementById('formularioEdicion').style.display = 'none';
            
            // Mostrar mensaje de √©xito
            mostrarToast('success', 'Datos actualizados', 'Los cambios fueron guardados correctamente');
        }

        // ==================== FUNCIONES PARA MEDICAMENTOS EN EDICI√ìN Y SEGUIMIENTOS ====================
        function agregarMedicamentoEdicion() {
            agregarMedicamento('', '', '', 'editMedicamentosContainer');
        }

        function agrpZEAWYtiB6bJ16NuLbGCc6CZ6jJdKfb63() {
            agregarMedicamento('', '', '', 'nuevoSeguimientoMedicamentosContainer');
        }

        // ==================== SEGUIMIENTOS ====================
        function mostrarSeguimientosPaciente(paciente) {
            const grid = document.getElementById('seguimientosGrid');
            
            if (!paciente.seguimientos || paciente.seguimientos.length === 0) {
                grid.innerHTML = '<p style="text-align:center; padding:40px; background:#f8fafc; border-radius:12px;">No hay seguimientos registrados</p>';
                return;
            }
            
            const seguimientos = [...paciente.seguimientos].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            let html = '';
            for (let i = 0; i < seguimientos.length; i++) {
                const s = seguimientos[i];
                const esNuevo = i === 0;
                
                let medicamentosHtml = '';
                if (s.medicamentos && s.medicamentos.length > 0) {
                    medicamentosHtml = '<div class="medicamentos-lista">';
                    s.medicamentos.forEach(med => {
                        medicamentosHtml += `
                            <span class="medicamento-tag">
                                <strong>${med.nombre}</strong><br>
                                <small>${med.dosis} | Duraci√≥n: ${med.duracion}</small>
                            </span> 
                        `;
                    });
                    medicamentosHtml += '</div>';
                }
                
                html += `
                    <div class="seguimiento-card ${esNuevo ? 'nuevo' : ''}">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span class="seguimiento-fecha ${esNuevo ? 'nuevo' : ''}">
                                <i class="far fa-calendar-alt"></i> ${s.fecha}
                            </span>
                            ${esNuevo ? '<span style="background:var(--success); color:white; padding:2px 8px; border-radius:12px; font-size:11px;">M√ÅS RECIENTE</span>' : ''}
                        </div>
                        
                        <div style="margin:10px 0; padding:10px; background:#f8fafc; border-radius:8px;">
                            <p><strong><i class="fas fa-stethoscope"></i> Diagn√≥stico:</strong> ${s.diagnostico || paciente.enfermedad}</p>
                            <p><strong><i class="fas fa-pills"></i> Medicamentos recetados:</strong></p>
                            ${medicamentosHtml || '<p>Sin cambios en medicamentos</p>'}
                            <p><strong><i class="fas fa-chart-line"></i> Evoluci√≥n:</strong> ${s.evolucion}</p>
                            ${s.examenes ? `<p><strong><i class="fas fa-flask"></i> Ex√°menes realizados:</strong> ${s.examenes}</p>` : ''}
                            ${s.proximaCita ? `<p><strong><i class="fas fa-calendar-check"></i> Pr√≥xima cita:</strong> ${s.proximaCita}</p>` : ''}
                        </div>
                    </div>
                `;
            }
            
            grid.innerHTML = html;
        }

        function mostrarFormularioSeguimiento() {
            if (!pacienteActual) {
                mostrarToast('error', 'Error', 'Primero debe buscar un paciente');
                return;
            }
            
            document.getElementById('formularioSeguimiento').style.display = 'block';
            document.getElementById('nuevoSeguimientoFecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('nuevoSeguimientoDiagnostico').value = pacienteActual.enfermedad || '';
            
            // Limpiar y cargar medicamentos actuales
            document.getElementById('nuevoSeguimientoMedicamentosContainer').innerHTML = '';
            if (pacienteActual.medicamentos && pacienteActual.medicamentos.length > 0) {
                pacienteActual.medicamentos.forEach(med => {
                    agregarMedicamento(med.nombre, med.dosis, med.duracion, 'nuevoSeguimientoMedicamentosContainer');
                });
            } else {
                agregarMedicamento('', '', '', 'nuevoSeguimientoMedicamentosContainer');
            }
            
            document.getElementById('nuevoSeguimientoEvolucion').value = '';
            document.getElementById('nuevoSeguimientoExamenes').value = '';
            document.getElementById('nuevoSeguimientoProximaCita').value = pacienteActual.tratamiento?.proximaCita || '';
            
            // Scroll al formulario
            document.getElementById('formularioSeguimiento').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function ocultarFormularioSeguimiento() {
            document.getElementById('formularioSeguimiento').style.display = 'none';
        }

        function guardarNuevoSeguimiento() {
            if (!pacienteActual) return;
            
            const fecha = document.getElementById('nuevoSeguimientoFecha').value;
            if (!fecha) {
                mostrarToast('warning', 'Fecha requerida', 'Debe seleccionar una fecha');
                return;
            }
            
            const diagnostico = document.getElementById('nuevoSeguimientoDiagnostico').value.trim();
            const medicamentos = obtenerMedicamentos('nuevoSeguimientoMedicamentosContainer');
            const evolucion = document.getElementById('nuevoSeguimientoEvolucion').value.trim();
            
            if (!diagnostico) {
                mostrarToast('warning', 'Diagn√≥stico requerido', 'Debe ingresar el diagn√≥stico');
                return;
            }
            
            const nuevoSeguimiento = {
                fecha: fecha,
                diagnostico: diagnostico,
                medicamentos: medicamentos,
                evolucion: evolucion || 'Sin evoluci√≥n',
                examenes: document.getElementById('nuevoSeguimientoExamenes').value || null,
                proximaCita: document.getElementById('nuevoSeguimientoProximaCita').value || null,
                fechaRegistro: new Date().toLocaleString()
            };
            
            if (!pacienteActual.seguimientos) pacienteActual.seguimientos = [];
            pacienteActual.seguimientos.push(nuevoSeguimiento);
            
            // Actualizar diagn√≥stico principal si cambi√≥
            if (diagnostico && diagnostico !== pacienteActual.enfermedad) {
                pacienteActual.enfermedad = diagnostico;
            }
            
            // Actualizar medicamentos principales
            if (medicamentos && medicamentos.length > 0) {
                pacienteActual.medicamentos = medicamentos;
            }
            
            if (nuevoSeguimiento.proximaCita) {
                if (!pacienteActual.tratamiento) pacienteActual.tratamiento = {};
                pacienteActual.tratamiento.proximaCita = nuevoSeguimiento.proximaCita;
            }
            
            pacienteActual.ultimaActualizacion = new Date().toISOString();
            guardarPacientes();
            
            // Actualizar vistas
            mostrarSeguimientosPaciente(pacienteActual);
            mostrarDatosPaciente(pacienteActual);
            
            ocultarFormularioSeguimiento();
            mostrarToast('success', 'Seguimiento guardado', 'Se agreg√≥ al historial');
        }

        // ==================== EX√ÅMENES ====================
        function mostrarExamenesPaciente(paciente) {
            const grid = document.getElementById('examenesGrid');
            
            if (!paciente.examenes || paciente.examenes.length === 0) {
                grid.innerHTML = '<p style="text-align:center; padding:40px; background:#f8fafc; border-radius:12px;">No hay ex√°menes registrados</p>';
                return;
            }
            
            let html = '';
            paciente.examenes.forEach(ex => {
                const tieneHistorial = ex.historial && ex.historial.length > 0;
                const seleccionado = examenSeleccionadoId === ex.id;
                
                html += `
                    <div class="examen-card ${seleccionado ? 'selected' : ''}" onclick="seleccionarExamen('${ex.id}')">
                        <div class="examen-header">
                            <span class="examen-nombre">${ex.nombre}</span>
                            <span class="examen-categoria">${ex.categoria}</span>
                        </div>
                        
                        <div class="examen-valor-actual">${ex.valor}</div>
                        <div class="examen-unidad">${ex.unidad}</div>
                        <div class="examen-fecha">
                            <i class="far fa-calendar-alt"></i> ${ex.fecha || ex.fechaFormateada || 'Fecha no disponible'}
                        </div>
                        
                        ${tieneHistorial ? `
                            <div style="margin-top:10px; padding-top:10px; border-top:1px dashed #e2e8f0;">
                                <small style="color:var(--gray);"><i class="fas fa-history"></i> ${ex.historial.length} cambio(s) anterior(es)</small>
                            </div>
                        ` : ''}
                        
                        <div class="examen-acciones">
                            <button class="btn-icon-small" style="background:var(--warning);" onclick="event.stopPropagation(); editarExamen('${ex.id}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn-icon-small" style="background:var(--danger);" onclick="event.stopPropagation(); eliminarExamen('${ex.id}')">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }

        function seleccionarExamen(examenId) {
            if (!pacienteActual?.examenes) return;
            
            const examen = pacienteActual.examenes.find(e => e.id === examenId);
            if (!examen) return;
            
            if (examenSeleccionadoId === examenId) {
                examenSeleccionadoId = null;
                document.getElementById('btnCerrarComparacion').style.display = 'none';
                document.getElementById('comparacionExamenPanel').style.display = 'none';
            } else {
                examenSeleccionadoId = examenId;
                mostrarComparacionExamen(examen);
            }
            
            mostrarExamenesPaciente(pacienteActual);
        }

        function mostrarComparacionExamen(examen) {
            const panel = document.getElementById('comparacionExamenPanel');
            const historial = examen.historial || [];
            
            if (historial.length === 0) {
                panel.innerHTML = `
                    <div class="comparacion-titulo">
                        <h3><i class="fas fa-info-circle"></i> ${examen.nombre}</h3>
                        <button class="btn-cerrar-comparacion" onclick="cerrarComparacionExamen()">
                            <i class="fas fa-times"></i> Cerrar
                        </button>
                    </div>
                    <div style="text-align: center; padding: 30px; background: white; border-radius: 12px;">
                        <i class="fas fa-flask" style="font-size: 48px; color: var(--gray); margin-bottom: 15px;"></i>
                        <h4>No hay historial de cambios</h4>
                        <p style="color: var(--gray); margin-top: 10px;">Este examen solo tiene el valor actual: <strong>${examen.valor} ${examen.unidad}</strong></p>
                        <p style="color: var(--gray);">Fecha: ${examen.fecha || examen.fechaFormateada || 'Fecha no disponible'}</p>
                    </div>
                `;
                panel.style.display = 'block';
                document.getElementById('btnCerrarComparacion').style.display = 'inline-flex';
                return;
            }
            
            const ultimoCambio = historial[historial.length - 1];
            const valorAnterior = parseFloat(ultimoCambio.valorAnterior);
            const valorActual = parseFloat(examen.valor);
            const diferencia = valorActual - valorAnterior;
            const porcentaje = ((diferencia / valorAnterior) * 100).toFixed(1);
            
            let historialHTML = '';
            if (historial.length > 1) {
                historialHTML = '<div class="timeline-container"><h4><i class="fas fa-history"></i> Historial completo de cambios</h4>';
                
                historial.forEach((h, index) => {
                    const cambio = parseFloat(h.valorNuevo) - parseFloat(h.valorAnterior);
                    historialHTML += `
                        <div class="timeline-item">
                            <div class="timeline-fecha">${h.fecha || 'Fecha no disponible'}</div>
                            <div class="timeline-valores">
                                <span class="timeline-valor-anterior">${h.valorAnterior}</span>
                                <i class="fas fa-arrow-right" style="color: var(--gray);"></i>
                                <span class="timeline-valor-nuevo">${h.valorNuevo}</span>
                                <span class="timeline-cambio-badge ${cambio >= 0 ? 'cambio-up' : 'cambio-down'}">
                                    ${cambio >= 0 ? '+' : ''}${cambio.toFixed(1)}
                                </span>
                            </div>
                        </div>
                    `;
                });
                
                historialHTML += '</div>';
            }
            
            panel.innerHTML = `
                <div class="comparacion-titulo">
                    <h3><i class="fas fa-balance-scale"></i> Comparaci√≥n: ${examen.nombre}</h3>
                    <button class="btn-cerrar-comparacion" onclick="cerrarComparacionExamen()">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                </div>
                
                <div class="comparacion-grid">
                    <div class="comparacion-columna anterior">
                        <div class="comparacion-header">
                            <span class="comparacion-badge badge-anterior">ANTERIOR</span>
                            <span class="comparacion-fecha">${ultimoCambio.fecha || 'Fecha no disponible'}</span>
                        </div>
                        <div class="comparacion-valor">${ultimoCambio.valorAnterior}</div>
                        <div class="comparacion-unidad">${examen.unidad}</div>
                    </div>
                    
                    <div class="comparacion-columna nuevo">
                        <div class="comparacion-header">
                            <span class="comparacion-badge badge-nuevo">ACTUAL</span>
                            <span class="comparacion-fecha">${examen.fecha || examen.fechaFormateada || 'Fecha no disponible'}</span>
                        </div>
                        <div class="comparacion-valor">${examen.valor}</div>
                        <div class="comparacion-unidad">${examen.unidad}</div>
                    </div>
                </div>
                
                <div class="comparacion-diferencia">
                    <div class="diferencia-label">Diferencia</div>
                    <div class="diferencia-valor ${diferencia >= 0 ? 'diferencia-positiva' : 'diferencia-negativa'}">
                        ${diferencia >= 0 ? '+' : ''}${diferencia.toFixed(1)} ${examen.unidad}
                        <span style="font-size: 16px; margin-left: 10px;">(${porcentaje}%)</span>
                    </div>
                    <div style="margin-top: 8px;">
                        <i class="fas ${diferencia >= 0 ? 'fa-arrow-up' : 'fa-arrow-down'}"></i>
                        ${diferencia >= 0 ? 'Aument√≥' : 'Disminuy√≥'}
                    </div>
                </div>
                
                ${historialHTML}
            `;
            
            panel.style.display = 'block';
            document.getElementById('btnCerrarComparacion').style.display = 'inline-flex';
        }

        function cerrarComparacionExamen() {
            examenSeleccionadoId = null;
            document.getElementById('comparacionExamenPanel').style.display = 'none';
            document.getElementById('btnCerrarComparacion').style.display = 'none';
            if (pacienteActual) {
                mostrarExamenesPaciente(pacienteActual);
            }
        }

        function mostrarModalNuevoExamen() {
            document.getElementById('modalExamenTitulo').innerHTML = '<i class="fas fa-flask"></i> Nuevo Examen';
            document.getElementById('examenSelect').value = '';
            document.getElementById('examenValor').value = '';
            document.getElementById('examenUnidad').value = '';
            document.getElementById('examenFecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('examenHora').value = new Date().toTimeString().slice(0,5);
            document.getElementById('btnGuardarExamen').onclick = guardarNuevoExamen;
            indiceExamenEditando = null;
            document.getElementById('modalExamen').classList.add('active');
        }

        function editarExamen(examenId) {
            if (!pacienteActual?.examenes) return;
            
            const index = pacienteActual.examenes.findIndex(e => e.id === examenId);
            if (index === -1) return;
            
            const ex = pacienteActual.examenes[index];
            indiceExamenEditando = index;
            
            const select = document.getElementById('examenSelect');
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].value === ex.id) {
                    select.selectedIndex = i;
                    break;
                }
            }
            
            document.getElementById('examenValor').value = ex.valor;
            document.getElementById('examenUnidad').value = ex.unidad;
            
            // Extraer fecha y hora del campo fecha
            if (ex.fechaISO) {
                const fecha = new Date(ex.fechaISO);
                document.getElementById('examenFecha').value = fecha.toISOString().split('T')[0];
                document.getElementById('examenHora').value = fecha.toTimeString().slice(0,5);
            } else {
                document.getElementById('examenFecha').value = new Date().toISOString().split('T')[0];
                document.getElementById('examenHora').value = new Date().toTimeString().slice(0,5);
            }
            
            document.getElementById('modalExamenTitulo').innerHTML = '<i class="fas fa-edit"></i> Editar Examen';
            document.getElementById('btnGuardarExamen').onclick = guardarEdicionExamen;
            document.getElementById('modalExamen').classList.add('active');
        }

        function guardarNuevoExamen() {
            if (!pacienteActual) return;
            
            const select = document.getElementById('examenSelect');
            const examenId = select.value;
            if (!examenId) { 
                mostrarToast('warning', 'Seleccione examen', 'Debe seleccionar un tipo de examen'); 
                return; 
            }
            
            const valor = document.getElementById('examenValor').value.trim();
            if (!valor) { 
                mostrarToast('warning', 'Ingrese valor', 'El valor del examen es obligatorio'); 
                return; 
            }
            
            const fecha = document.getElementById('examenFecha').value;
            if (!fecha) {
                mostrarToast('warning', 'Fecha requerida', 'Debe seleccionar la fecha del examen');
                return;
            }
            
            const hora = document.getElementById('examenHora').value;
            const fechaISO = new Date(fecha + 'T' + (hora || '00:00')).toISOString();
            const fechaFormateada = formatearFecha(fechaISO, hora);
            
            const opt = select.options[select.selectedIndex];
            const nombre = opt.text.split(' (')[0];
            const unidad = opt.dataset.unidad;
            
            const existente = pacienteActual.examenes?.find(e => e.id === examenId);
            
            if (existente) {
                // Guardar en historial
                if (!existente.historial) existente.historial = [];
                existente.historial.push({
                    fecha: existente.fecha,
                    fechaISO: existente.fechaISO,
                    valorAnterior: existente.valor,
                    valorNuevo: valor
                });
                
                // Actualizar valores
                existente.valor = valor;
                existente.fecha = fechaFormateada;
                existente.fechaISO = fechaISO;
                existente.hora = hora;
                existente.fechaFormateada = fechaFormateada;
                
                mostrarToast('info', 'Examen actualizado', `Nuevo valor: ${valor} ${unidad}`);
            } else {
                // Crear nuevo examen
                if (!pacienteActual.examenes) pacienteActual.examenes = [];
                pacienteActual.examenes.push({
                    id: examenId,
                    nombre: nombre,
                    categoria: examenesLista.find(e => e.id === examenId)?.categoria || '',
                    valor: valor,
                    unidad: unidad,
                    fecha: fechaFormateada,
                    fechaISO: fechaISO,
                    hora: hora,
                    fechaFormateada: fechaFormateada,
                    historial: []
                });
                mostrarToast('success', 'Examen agregado', 'Nuevo examen registrado');
            }
            
            pacienteActual.ultimaActualizacion = new Date().toISOString();
            guardarPacientes();
            cerrarModalExamen();
            mostrarExamenesPaciente(pacienteActual);
            cerrarComparacionExamen();
        }

        function guardarEdicionExamen() {
            if (!pacienteActual || indiceExamenEditando === null) return;
            
            const examen = pacienteActual.examenes[indiceExamenEditando];
            const valor = document.getElementById('examenValor').value.trim();
            
            if (!valor) { 
                mostrarToast('warning', 'Ingrese valor', 'El valor del examen es obligatorio'); 
                return; 
            }
            
            const fecha = document.getElementById('examenFecha').value;
            if (!fecha) {
                mostrarToast('warning', 'Fecha requerida', 'Debe seleccionar la fecha del examen');
                return;
            }
            
            const hora = document.getElementById('examenHora').value;
            const fechaISO = new Date(fecha + 'T' + (hora || '00:00')).toISOString();
            const fechaFormateada = formatearFecha(fechaISO, hora);
            
            // Guardar en historial
            if (!examen.historial) examen.historial = [];
            examen.historial.push({
                fecha: examen.fecha,
                fechaISO: examen.fechaISO,
                valorAnterior: examen.valor,
                valorNuevo: valor
            });
            
            // Actualizar valores
            examen.valor = valor;
            examen.fecha = fechaFormateada;
            examen.fechaISO = fechaISO;
            examen.hora = hora;
            examen.fechaFormateada = fechaFormateada;
            
            pacienteActual.ultimaActualizacion = new Date().toISOString();
            guardarPacientes();
            cerrarModalExamen();
            mostrarExamenesPaciente(pacienteActual);
            cerrarComparacionExamen();
            mostrarToast('success', 'Examen actualizado', 'Los cambios han sido guardados');
        }

        function eliminarExamen(examenId) {
            if (!pacienteActual?.examenes) return;
            if (confirm('¬øEliminar este examen?')) {
                pacienteActual.examenes = pacienteActual.examenes.filter(e => e.id !== examenId);
                guardarPacientes();
                mostrarExamenesPaciente(pacienteActual);
                if (examenSeleccionadoId === examenId) {
                    cerrarComparacionExamen();
                }
                mostrarToast('warning', 'Examen eliminado', 'El examen fue removido');
            }
        }

        function cerrarModalExamen() {
            document.getElementById('modalExamen').classList.remove('active');
            indiceExamenEditando = null;
        }

        // ==================== EXCEL ====================
        function exportarExcelCompleto() {
            if (pacientes.length === 0) {
                mostrarToast('warning', 'Sin datos', 'No hay pacientes para exportar');
                return;
            }
            
            const datos = pacientes.map(p => {
                const medicamentosStr = p.medicamentos ? 
                    p.medicamentos.map(m => `${m.nombre} - ${m.dosis} (Duraci√≥n: ${m.duracion})`).join('; ') : '';
                
                return {
                    'C√≥digo': p.codigo,
                    'Nombre': p.nombre,
                    'Edad': p.edad,
                    'Sexo': p.sexo,
                    'Diagn√≥stico': p.enfermedad,
                    'Medicamentos (con duraci√≥n)': medicamentosStr,
                    'Tel√©fono': p.telefono,
                    'Pr√≥xima Cita': p.tratamiento?.proximaCita || '',
                    'Total Ex√°menes': p.examenes?.length || 0,
                    'Total Seguimientos': p.seguimientos?.length || 0,
                    'Fecha Registro': new Date(p.fechaRegistro).toLocaleDateString()
                };
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(datos);
            XLSX.utils.book_append_sheet(wb, ws, "Pacientes");
            XLSX.writeFile(wb, `todos_pacientes_${new Date().toISOString().slice(0,10)}.xlsx`);
            mostrarToast('success', 'Exportado', `${pacientes.length} pacientes exportados`);
        }

        function exportarExcelResumen() {
            const hombres = pacientes.filter(p => p.sexo === 'Masculino').length;
            const mujeres = pacientes.filter(p => p.sexo === 'Femenino').length;
            const edadProm = pacientes.reduce((a, c) => a + c.edad, 0) / pacientes.length || 0;
            
            const datos = [
                { 'M√©trica': 'Total Pacientes', 'Valor': pacientes.length },
                { 'M√©trica': 'Hombres', 'Valor': hombres },
                { 'M√©trica': 'Mujeres', 'Valor': mujeres },
                { 'M√©trica': 'Edad Promedio', 'Valor': edadProm.toFixed(1) }
            ];
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(datos);
            XLSX.utils.book_append_sheet(wb, ws, "Resumen");
            XLSX.writeFile(wb, `resumen_${new Date().toISOString().slice(0,10)}.xlsx`);
            mostrarToast('success', 'Resumen exportado');
        }

        function exportarExcelPacienteIndividual() {
            document.getElementById('exportarPacienteInput').value = '';
            document.getElementById('resultadoExportar').innerHTML = '';
            document.getElementById('btnConfirmarExportar').style.display = 'none';
            pacienteSeleccionadoExportar = null;
            document.getElementById('modalExportarPaciente').classList.add('active');
            
            // Agregar evento al input para b√∫squeda en tiempo real
            document.getElementById('exportarPacienteInput').oninput = function() {
                buscarPacienteParaExportar(this.value);
            };
        }

        function buscarPacienteParaExportar(texto) {
            texto = texto.toLowerCase().trim();
            const resultadoDiv = document.getElementById('resultadoExportar');
            
            if (!texto) {
                resultadoDiv.innerHTML = '';
                document.getElementById('btnConfirmarExportar').style.display = 'none';
                return;
            }
            
            const pacientesEncontrados = pacientes.filter(p => 
                p.nombre.toLowerCase().includes(texto) || 
                p.codigo.toLowerCase().includes(texto)
            );
            
            if (pacientesEncontrados.length === 0) {
                resultadoDiv.innerHTML = '<p style="color: var(--danger); padding: 10px;">No se encontraron pacientes</p>';
                document.getElementById('btnConfirmarExportar').style.display = 'none';
                return;
            }
            
            let html = '<div style="margin-top: 10px;">';
            pacientesEncontrados.forEach(p => {
                html += `
                    <div onclick="seleccionarPacienteExportar('${p.codigo}')" style="padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 8px; cursor: pointer; background: ${pacienteSeleccionadoExportar?.codigo === p.codigo ? 'var(--primary)' : 'white'}; color: ${pacienteSeleccionadoExportar?.codigo === p.codigo ? 'white' : 'inherit'};">
                        <strong>${p.nombre}</strong><br>
                        <small>C√≥digo: ${p.codigo} | Edad: ${p.edad} a√±os</small>
                    </div>
                `;
            });
            html += '</div>';
            
            resultadoDiv.innerHTML = html;
        }

        function seleccionarPacienteExportar(codigo) {
            pacienteSeleccionadoExportar = pacientes.find(p => p.codigo === codigo);
            document.getElementById('btnConfirmarExportar').style.display = 'inline-flex';
            buscarPacienteParaExportar(document.getElementById('exportarPacienteInput').value);
        }

        function cerrarModalExportar() {
            document.getElementById('modalExportarPaciente').classList.remove('active');
            pacienteSeleccionadoExportar = null;
        }

        function exportarPacienteSeleccionado() {
            if (!pacienteSeleccionadoExportar) {
                mostrarToast('warning', 'Seleccione paciente', 'Debe seleccionar un paciente de la lista');
                return;
            }
            
            exportarHistorialCompleto(pacienteSeleccionadoExportar);
            cerrarModalExportar();
        }

        function exportarExcelPacienteActual() {
            if (!pacienteActual) {
                mostrarToast('warning', 'Sin paciente', 'Primero busque un paciente');
                return;
            }
            
            exportarHistorialCompleto(pacienteActual);
        }

        function exportarHistorialCompleto(paciente) {
            const datosHistorial = [];
            
            // Datos generales
            datosHistorial.push({
                'Tipo': 'DATOS GENERALES',
                'Fecha': '-',
                'Campo': 'Nombre',
                'Valor': paciente.nombre
            });
            datosHistorial.push({
                'Tipo': 'DATOS GENERALES',
                'Fecha': '-',
                'Campo': 'C√≥digo',
                'Valor': paciente.codigo
            });
            datosHistorial.push({
                'Tipo': 'DATOS GENERALES',
                'Fecha': '-',
                'Campo': 'Edad',
                'Valor': paciente.edad
            });
            datosHistorial.push({
                'Tipo': 'DATOS GENERALES',
                'Fecha': '-',
                'Campo': 'Sexo',
                'Valor': paciente.sexo
            });
            datosHistorial.push({
                'Tipo': 'DATOS GENERALES',
                'Fecha': '-',
                'Campo': 'Diagn√≥stico',
                'Valor': paciente.enfermedad
            });
            datosHistorial.push({
                'Tipo': 'DATOS GENERALES',
                'Fecha': '-',
                'Campo': 'Tel√©fono',
                'Valor': paciente.telefono || 'No especificado'
            });
            
            if (paciente.medicamentos && paciente.medicamentos.length > 0) {
                paciente.medicamentos.forEach(med => {
                    datosHistorial.push({
                        'Tipo': 'MEDICAMENTO',
                        'Fecha': '-',
                        'Campo': 'Medicamento',
                        'Valor': `${med.nombre} - ${med.dosis} (Duraci√≥n: ${med.duracion})`
                    });
                });
            }
            
            // Seguimientos
            if (paciente.seguimientos && paciente.seguimientos.length > 0) {
                paciente.seguimientos.forEach(s => {
                    datosHistorial.push({
                        'Tipo': 'SEGUIMIENTO',
                        'Fecha': s.fecha,
                        'Campo': 'Diagn√≥stico',
                        'Valor': s.diagnostico || paciente.enfermedad
                    });
                    
                    if (s.medicamentos && s.medicamentos.length > 0) {
                        s.medicamentos.forEach(med => {
                            datosHistorial.push({
                                'Tipo': 'SEGUIMIENTO',
                                'Fecha': s.fecha,
                                'Campo': 'Medicamento',
                                'Valor': `${med.nombre} - ${med.dosis} (Duraci√≥n: ${med.duracion})`
                            });
                        });
                    }
                    
                    datosHistorial.push({
                        'Tipo': 'SEGUIMIENTO',
                        'Fecha': s.fecha,
                        'Campo': 'Evoluci√≥n',
                        'Valor': s.evolucion
                    });
                    if (s.examenes) {
                        datosHistorial.push({
                            'Tipo': 'SEGUIMIENTO',
                            'Fecha': s.fecha,
                            'Campo': 'Ex√°menes',
                            'Valor': s.examenes
                        });
                    }
                    if (s.proximaCita) {
                        datosHistorial.push({
                            'Tipo': 'SEGUIMIENTO',
                            'Fecha': s.fecha,
                            'Campo': 'Pr√≥xima Cita',
                            'Valor': s.proximaCita
                        });
                    }
                });
            }
            
            // Ex√°menes
            if (paciente.examenes && paciente.examenes.length > 0) {
                paciente.examenes.forEach(ex => {
                    datosHistorial.push({
                        'Tipo': 'EXAMEN',
                        'Fecha': ex.fecha || ex.fechaFormateada || 'Fecha no disponible',
                        'Campo': ex.nombre,
                        'Valor': `${ex.valor} ${ex.unidad}`
                    });
                    
                    if (ex.historial && ex.historial.length > 0) {
                        ex.historial.forEach(h => {
                            datosHistorial.push({
                                'Tipo': 'EXAMEN (HISTORIAL)',
                                'Fecha': h.fecha || 'Fecha no disponible',
                                'Campo': ex.nombre,
                                'Valor': `${h.valorAnterior} ‚Üí ${h.valorNuevo} ${ex.unidad}`
                            });
                        });
                    }
                });
            }
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(datosHistorial);
            XLSX.utils.book_append_sheet(wb, ws, "Historial Completo");
            XLSX.writeFile(wb, `historial_${paciente.nombre}_${new Date().toISOString().slice(0,10)}.xlsx`);
            mostrarToast('success', 'Historial exportado', `Se export√≥ el historial completo de ${paciente.nombre}`);
        }

        // ==================== IMPRESI√ìN ====================
        function imprimirHistorialPaciente() {
            if (!pacienteActual) {
                mostrarToast('warning', 'Sin paciente', 'Primero busque un paciente');
                return;
            }
            
            const contenidoImpresion = document.getElementById('impresion-contenido');
            
            let html = `
                <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h1 style="color: #2563eb; margin-bottom: 5px;">MediData Pro</h1>
                        <h2 style="color: #64748b; font-weight: normal;">Historial Cl√≠nico del Paciente</h2>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                        <h3 style="margin-bottom: 15px;">${pacienteActual.nombre}</h3>
                        <p><strong>C√≥digo:</strong> ${pacienteActual.codigo}</p>
                        <p><strong>Edad:</strong> ${pacienteActual.edad} a√±os</p>
                        <p><strong>Sexo:</strong> ${pacienteActual.sexo}</p>
                        <p><strong>Diagn√≥stico:</strong> ${pacienteActual.enfermedad}</p>
                        <p><strong>Tel√©fono:</strong> ${pacienteActual.telefono || 'No especificado'}</p>
                        <p><strong>Medicamentos actuales (con duraci√≥n):</strong></p>
                        <ul>
            `;
            
            if (pacienteActual.medicamentos && pacienteActual.medicamentos.length > 0) {
                pacienteActual.medicamentos.forEach(med => {
                    html += `<li><strong>${med.nombre}</strong> - ${med.dosis} (Duraci√≥n: ${med.duracion})</li>`;
                });
            } else {
                html += '<li>No hay medicamentos recetados</li>';
            }
            
            html += `
                        </ul>
                        <p><strong>Pr√≥xima cita de control:</strong> ${pacienteActual.tratamiento?.proximaCita || 'No programada'}</p>
                        <p><strong>Fecha de registro:</strong> ${new Date(pacienteActual.fechaRegistro).toLocaleDateString()}</p>
                    </div>
            `;
            
            // Seguimientos
            if (pacienteActual.seguimientos && pacienteActual.seguimientos.length > 0) {
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #22c55e; border-bottom: 2px solid #22c55e; padding-bottom: 10px; margin-bottom: 20px;">
                            <i class="fas fa-history"></i> Historial de Seguimientos
                        </h3>
                `;
                
                const seguimientos = [...pacienteActual.seguimientos].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                seguimientos.forEach(s => {
                    html += `
                        <div style="border-left: 4px solid #22c55e; padding: 15px; margin-bottom: 15px; background: #f8fafc; border-radius: 8px;">
                            <p style="color: #64748b; margin-bottom: 8px;"><strong>Fecha:</strong> ${s.fecha}</p>
                            <p><strong>Diagn√≥stico:</strong> ${s.diagnostico || pacienteActual.enfermedad}</p>
                            <p><strong>Medicamentos recetados en esta consulta:</strong></p>
                            <ul>
                    `;
                    
                    if (s.medicamentos && s.medicamentos.length > 0) {
                        s.medicamentos.forEach(med => {
                            html += `<li><strong>${med.nombre}</strong> - ${med.dosis} (Duraci√≥n: ${med.duracion})</li>`;
                        });
                    } else {
                        html += '<li>Sin cambios en medicamentos</li>';
                    }
                    
                    html += `
                            </ul>
                            <p><strong>Evoluci√≥n:</strong> ${s.evolucion}</p>
                            ${s.examenes ? `<p><strong>Ex√°menes realizados:</strong> ${s.examenes}</p>` : ''}
                            ${s.proximaCita ? `<p><strong>Pr√≥xima cita indicada:</strong> ${s.proximaCita}</p>` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            // Ex√°menes
            if (pacienteActual.examenes && pacienteActual.examenes.length > 0) {
                html += `
                    <div>
                        <h3 style="color: #7c3aed; border-bottom: 2px solid #7c3aed; padding-bottom: 10px; margin-bottom: 20px;">
                            <i class="fas fa-flask"></i> Ex√°menes M√©dicos
                        </h3>
                `;
                
                pacienteActual.examenes.forEach(ex => {
                    html += `
                        <div style="border: 1px solid #e2e8f0; padding: 15px; margin-bottom: 15px; border-radius: 8px;">
                            <h4 style="color: #2563eb; margin-bottom: 10px;">${ex.nombre} <span style="color: #64748b; font-size: 12px;">(${ex.categoria})</span></h4>
                            <p><strong>Valor actual:</strong> ${ex.valor} ${ex.unidad}</p>
                            <p><strong>Fecha del examen:</strong> ${ex.fecha || ex.fechaFormateada || 'Fecha no disponible'}</p>
                    `;
                    
                    if (ex.historial && ex.historial.length > 0) {
                        html += '<div style="margin-top: 10px;"><strong>Historial de cambios:</strong><ul style="margin-top: 5px;">';
                        ex.historial.forEach(h => {
                            html += `<li style="font-size: 12px; color: #64748b;">${h.fecha || 'Fecha no disponible'}: ${h.valorAnterior} ‚Üí ${h.valorNuevo} ${ex.unidad}</li>`;
                        });
                        html += '</ul></div>';
                    }
                    
                    html += '</div>';
                });
                
                html += '</div>';
            }
            
            html += `
                <div style="margin-top: 30px; text-align: center; color: #64748b; font-size: 12px; border-top: 1px solid #e2e8f0; padding-top: 20px;">
                    <p>Documento generado el ${new Date().toLocaleString()}</p>
                    <p>MediData Pro - Sistema de Gesti√≥n Cl√≠nica</p>
                </div>
            </div>`;
            
            contenidoImpresion.innerHTML = html;
            contenidoImpresion.style.display = 'block';
            
            window.print();
            
            contenidoImpresion.style.display = 'none';
        }

        // ==================== FILTROS ====================
        function filtrarTodos() {
            mostrarToast('info', 'Filtro aplicado', 'Mostrando todos los pacientes');
        }

        function filtrarHombres() {
            mostrarToast('info', 'Filtro aplicado', 'Mostrando pacientes masculinos');
        }

        function filtrarMujeres() {
            mostrarToast('info', 'Filtro aplicado', 'Mostrando pacientes femeninos');
        }

        // ==================== TOAST ====================
        function mostrarToast(tipo, titulo, mensaje) {
            const toast = document.getElementById('toast');
            document.getElementById('toastTitle').textContent = titulo;
            document.getElementById('toastMessage').textContent = mensaje;
            toast.className = 'toast ' + tipo;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function cerrarToast() {
            document.getElementById('toast').classList.remove('show');
        }

        // Exponer funciones globalmente
        window.cambiarCategoria = cambiarCategoria;
        window.guardarPacienteCompleto = guardarPacienteCompleto;
        window.agregarMedicamento = agregarMedicamento;
        window.eliminarMedicamento = eliminarMedicamento;
        window.buscarPaciente = buscarPaciente;
        window.limpiarBusqueda = limpiarBusqueda;
        window.mostrarFormularioEdicion = mostrarFormularioEdicion;
        window.cancelarEdicion = cancelarEdicion;
        window.guardarEdicionPaciente = guardarEdicionPaciente;
        window.agregarMedicamentoEdicion = agregarMedicamentoEdicion;
        window.agrpZEAWYtiB6bJ16NuLbGCc6CZ6jJdKfb63 = agrpZEAWYtiB6bJ16NuLbGCc6CZ6jJdKfb63;
        window.mostrarFormularioSeguimiento = mostrarFormularioSeguimiento;
        window.ocultarFormularioSeguimiento = ocultarFormularioSeguimiento;
        window.guardarNuevoSeguimiento = guardarNuevoSeguimiento;
        window.seleccionarExamen = seleccionarExamen;
        window.editarExamen = editarExamen;
        window.eliminarExamen = eliminarExamen;
        window.cerrarComparacionExamen = cerrarComparacionExamen;
        window.mostrarModalNuevoExamen = mostrarModalNuevoExamen;
        window.cerrarModalExamen = cerrarModalExamen;
        window.guardarExamen = guardarNuevoExamen;
        window.exportarExcelCompleto = exportarExcelCompleto;
        window.exportarExcelResumen = exportarExcelResumen;
        window.exportarExcelPacienteIndividual = exportarExcelPacienteIndividual;
        window.exportarExcelPacienteActual = exportarExcelPacienteActual;
        window.seleccionarPacienteExportar = seleccionarPacienteExportar;
        window.exportarPacienteSeleccionado = exportarPacienteSeleccionado;
        window.cerrarModalExportar = cerrarModalExportar;
        window.imprimirHistorialPaciente = imprimirHistorialPaciente;
        window.filtrarTodos = filtrarTodos;
        window.filtrarHombres = filtrarHombres;
        window.filtrarMujeres = filtrarMujeres;
        window.cerrarToast = cerrarToast;
    </script>
</body>
</html>
