<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>MediData Pro - Sistema de Gestión Clínica</title>
    
    <!-- Configuración PWA -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MediData Pro">
    
    <!-- Librerías -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --light: #f8fafc;
            --dark: #0f172a;
            --gray: #94a3b8;
            --border-radius: 12px;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 16px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 24px 32px;
            color: white;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-title i { font-size: 48px; }
        .header-title h1 { font-size: clamp(24px, 4vw, 32px); font-weight: 700; }

        .stats-grid {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(5px);
            padding: 12px 24px;
            border-radius: var(--border-radius);
            text-align: center;
            min-width: 120px;
            border: 1px solid rgba(255,255,255,0.2);
            cursor: pointer;
            transition: all 0.3s;
        }

        .stat-card:hover { background: rgba(255,255,255,0.25); transform: translateY(-2px); }
        .stat-card span { display: block; font-size: 28px; font-weight: 700; }
        .stat-card label { font-size: 12px; opacity: 0.9; text-transform: uppercase; }

        /* Sección Excel */
        .excel-section {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            padding: 24px;
            color: white;
        }

        .excel-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .excel-header i { font-size: 32px; }
        .excel-header h2 { font-size: 24px; font-weight: 600; }

        .excel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .excel-card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(5px);
            padding: 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .excel-card:hover { background: rgba(255,255,255,0.25); transform: translateY(-4px); }
        .excel-icon { font-size: 32px; margin-bottom: 12px; }
        .excel-card h3 { font-size: 18px; font-weight: 600; }
        .excel-card p { font-size: 13px; opacity: 0.9; margin: 8px 0 16px; }
        .excel-badge {
            display: inline-block;
            padding: 6px 16px;
            background: rgba(255,255,255,0.3);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Formularios */
        .form-section {
            padding: 24px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 24px;
            color: var(--dark);
            font-size: 20px;
            font-weight: 600;
        }

        .section-title i { color: var(--primary); }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-weight: 500;
            color: var(--dark);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }

        /* Tratamiento */
        .treatment-section {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }

        .treatment-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .treatment-header i { font-size: 24px; color: #d97706; }
        .treatment-header h3 { color: #92400e; font-size: 18px; font-weight: 600; }

        /* Tabs de exámenes */
        .examenes-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e2e8f0;
        }

        .examen-tab {
            padding: 10px 20px;
            background: #f1f5f9;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .examen-tab:hover { background: var(--primary); color: white; }
        .examen-tab.active { background: var(--primary); color: white; }

        .examenes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .examen-item {
            background: #f8fafc;
            padding: 12px;
            border-radius: 8px;
        }

        .examen-item label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .examen-item input {
            width: 100%;
            padding: 8px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
        }

        /* Botones */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }

        /* Tabla */
        .table-container {
            padding: 24px;
            background: white;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: var(--border-radius);
            border: 1px solid #e2e8f0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        th {
            background: #f8fafc;
            padding: 16px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            border-bottom: 2px solid #e2e8f0;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
        }

        tr:hover { background: #f8fafc; }

        .code-display {
            font-family: monospace;
            background: #f1f5f9;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
        }

        .sexo-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        .sexo-masculino { background: #dbeafe; color: #1e40af; }
        .sexo-femenino { background: #fce7f3; color: #9d174d; }
        .sexo-otro { background: #e0e7ff; color: #3730a3; }

        /* Acciones */
        .action-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-icon:hover { transform: scale(1.1); }
        .btn-view { background: var(--info); }
        .btn-edit { background: var(--warning); }
        .btn-delete { background: var(--danger); }
        .btn-lab { background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%); }
        .btn-history { background: var(--success); }
        .btn-compare { background: var(--primary); }

        /* Paginación */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 24px;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            min-width: 40px;
            font-weight: 500;
        }

        .pagination-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Seguimientos */
        .seguimiento-section {
            padding: 24px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
        }

        .seguimiento-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .seguimiento-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 16px;
        }

        .seguimiento-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            border-left: 4px solid var(--success);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .seguimiento-card.nuevo {
            border-left-color: var(--primary);
            background: #f0f9ff;
        }

        /* Comparación de seguimientos */
        .comparacion-container {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed #e2e8f0;
        }

        .cambio-item {
            background: #f8fafc;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .cambio-label {
            font-size: 11px;
            color: var(--gray);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .cambio-valores {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
        }

        .valor-anterior {
            color: var(--warning);
            text-decoration: line-through;
        }

        .valor-nuevo {
            color: var(--success);
            font-weight: 600;
        }

        .badge-cambios {
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            display: inline-block;
        }

        /* ESTILOS PARA COMPARACIÓN DE EXÁMENES */
        .examenes-historial-section {
            padding: 24px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
        }

        .examenes-historial-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .examen-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            border: 2px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .examen-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }

        .examen-card.selected {
            border: 3px solid var(--primary);
            background: #f0f9ff;
        }

        .examen-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .examen-nombre {
            font-weight: 700;
            color: var(--dark);
            font-size: 16px;
        }

        .examen-categoria {
            background: #f1f5f9;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 10px;
            color: var(--secondary);
            font-weight: 600;
        }

        .examen-valor-actual {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            text-align: center;
            margin: 10px 0 5px;
        }

        .examen-unidad {
            text-align: center;
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 10px;
        }

        .examen-fecha {
            font-size: 12px;
            color: var(--gray);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e2e8f0;
        }

        .examen-historial-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--info);
            color: white;
            border-radius: 20px;
            padding: 2px 8px;
            font-size: 10px;
            font-weight: 600;
        }

        /* Panel de comparación lado a lado */
        .comparacion-panel {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 30px;
            border: 3px solid var(--primary);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        .comparacion-titulo {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .comparacion-titulo h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
            font-size: 20px;
        }

        .btn-cerrar-comparacion {
            background: var(--gray);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
        }

        .btn-cerrar-comparacion:hover {
            background: var(--danger);
        }

        .comparacion-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            position: relative;
            margin-bottom: 20px;
        }

        .comparacion-grid::before {
            content: "VS";
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: var(--primary);
            color: white;
            padding: 12px 16px;
            border-radius: 50px;
            font-weight: 800;
            font-size: 18px;
            z-index: 10;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            border: 3px solid white;
        }

        .comparacion-columna {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .comparacion-columna.anterior {
            border-top: 6px solid var(--warning);
        }

        .comparacion-columna.nuevo {
            border-top: 6px solid var(--success);
        }

        .comparacion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px dashed #e2e8f0;
        }

        .comparacion-badge {
            padding: 6px 16px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 700;
        }

        .badge-anterior {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-nuevo {
            background: #d1fae5;
            color: #065f46;
        }

        .comparacion-fecha {
            font-size: 14px;
            color: var(--gray);
            font-weight: 500;
        }

        .comparacion-valor {
            font-size: 48px;
            font-weight: 800;
            text-align: center;
            margin: 20px 0 10px;
        }

        .comparacion-columna.anterior .comparacion-valor {
            color: var(--warning);
        }

        .comparacion-columna.nuevo .comparacion-valor {
            color: var(--success);
        }

        .comparacion-unidad {
            text-align: center;
            color: var(--gray);
            font-size: 16px;
            margin-bottom: 10px;
        }

        .comparacion-diferencia {
            text-align: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
            margin-top: 20px;
            border: 1px solid #e2e8f0;
        }

        .diferencia-label {
            font-size: 13px;
            color: var(--gray);
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .diferencia-valor {
            font-size: 24px;
            font-weight: 700;
        }

        .diferencia-positiva { color: var(--success); }
        .diferencia-negativa { color: var(--danger); }

        .timeline-container {
            margin-top: 30px;
            background: white;
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #e2e8f0;
        }

        .timeline-container h4 {
            margin-bottom: 15px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .timeline-item {
            display: flex;
            gap: 20px;
            margin-bottom: 12px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 10px;
            align-items: center;
        }

        .timeline-fecha {
            min-width: 150px;
            font-size: 13px;
            color: var(--gray);
        }

        .timeline-cambio {
            flex: 1;
        }

        .timeline-valores {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .timeline-valor-anterior {
            color: var(--warning);
            text-decoration: line-through;
            font-weight: 500;
        }

        .timeline-valor-nuevo {
            color: var(--success);
            font-weight: 700;
        }

        .timeline-cambio-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .cambio-up {
            background: #d1fae5;
            color: #065f46;
        }

        .cambio-down {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Filtros */
        .filters-section {
            padding: 24px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .filter-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
        }

        /* Modales */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e2e8f0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 30px;
            right: 30px;
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 3000;
            border-left: 4px solid var(--success);
        }

        .toast.show { transform: translateX(0); }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--danger); }
        .toast.warning { border-left-color: var(--warning); }

        .w-100 { width: 100%; }
        .mt-4 { margin-top: 16px; }
        .text-center { text-align: center; }
        .btn-icon-small {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-title">
                    <i class="fas fa-hospital-user"></i>
                    <h1>MediData Pro</h1>
                </div>
                <div class="stats-grid">
                    <div class="stat-card" onclick="filtrarTodos()">
                        <span id="totalPacientes">0</span>
                        <label>Total</label>
                    </div>
                    <div class="stat-card" onclick="filtrarHombres()">
                        <span id="hombresCount">0</span>
                        <label>Hombres</label>
                    </div>
                    <div class="stat-card" onclick="filtrarMujeres()">
                        <span id="mujeresCount">0</span>
                        <label>Mujeres</label>
                    </div>
                    <div class="stat-card">
                        <span id="edadPromedio">0</span>
                        <label>Edad Prom.</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Excel Section -->
        <div class="excel-section">
            <div class="excel-header">
                <i class="fas fa-file-excel"></i>
                <h2>Exportar a Excel</h2>
            </div>
            <div class="excel-grid">
                <div class="excel-card" onclick="exportarExcelCompleto()">
                    <div class="excel-icon"><i class="fas fa-database"></i></div>
                    <h3>Completo</h3>
                    <p>Todos los pacientes</p>
                    <span class="excel-badge">Exportar</span>
                </div>
                <div class="excel-card" onclick="exportarExcelFiltrado()">
                    <div class="excel-icon"><i class="fas fa-filter"></i></div>
                    <h3>Filtrado</h3>
                    <p>Resultados actuales</p>
                    <span class="excel-badge"><span id="filtradosCount">0</span> registros</span>
                </div>
                <div class="excel-card" onclick="exportarExcelResumen()">
                    <div class="excel-icon"><i class="fas fa-chart-pie"></i></div>
                    <h3>Resumen</h3>
                    <p>Estadísticas</p>
                    <span class="excel-badge">Exportar</span>
                </div>
                <div class="excel-card" onclick="exportarExcelExamenes()">
                    <div class="excel-icon"><i class="fas fa-flask"></i></div>
                    <h3>Exámenes</h3>
                    <p>Del paciente actual</p>
                    <span class="excel-badge">Exportar</span>
                </div>
            </div>
        </div>

        <!-- Formulario de registro -->
        <div class="form-section">
            <div class="section-title">
                <i class="fas fa-user-plus"></i>
                <h2>Registro de Paciente</h2>
            </div>
            <form onsubmit="event.preventDefault(); guardarPacienteCompleto();">
                <div class="form-grid">
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> Nombre *</label>
                        <input type="text" id="nombre" placeholder="Nombre completo" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-calendar"></i> Edad *</label>
                        <input type="number" id="edad" placeholder="Edad" min="0" max="120" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-venus-mars"></i> Sexo *</label>
                        <select id="sexo" required>
                            <option value="">Seleccionar...</option>
                            <option value="Masculino">Masculino</option>
                            <option value="Femenino">Femenino</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-stethoscope"></i> Diagnóstico *</label>
                        <input type="text" id="enfermedad" placeholder="Diagnóstico principal" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-notes-medical"></i> Observaciones</label>
                        <textarea id="observaciones" placeholder="Notas iniciales..." rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-phone"></i> Teléfono</label>
                        <input type="tel" id="telefono" placeholder="Teléfono de contacto">
                    </div>
                </div>

                <!-- Tratamiento -->
                <div class="treatment-section">
                    <div class="treatment-header">
                        <i class="fas fa-notes-medical"></i>
                        <h3>Plan de Tratamiento Inicial</h3>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label><i class="fas fa-pills"></i> Medicamentos</label>
                            <input type="text" id="medicamentos" placeholder="Ej: Paracetamol 500mg c/8h">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-clock"></i> Duración</label>
                            <input type="text" id="duracion" placeholder="Ej: 7 días">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-clipboard-list"></i> Indicaciones</label>
                            <textarea id="indicaciones" placeholder="Instrucciones adicionales..." rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-calendar-check"></i> Próxima cita</label>
                            <input type="date" id="proximaCita">
                        </div>
                    </div>
                </div>

                <!-- Exámenes de ingreso -->
                <div class="section-title">
                    <i class="fas fa-flask"></i>
                    <h2>Exámenes de Ingreso</h2>
                </div>

                <div class="examenes-tabs">
                    <button class="examen-tab active" type="button" onclick="cambiarCategoria('hematologia', this)">Hematología</button>
                    <button class="examen-tab" type="button" onclick="cambiarCategoria('quimica', this)">Química</button>
                    <button class="examen-tab" type="button" onclick="cambiarCategoria('hierro', this)">Vitaminas</button>
                    <button class="examen-tab" type="button" onclick="cambiarCategoria('hepatica', this)">Hepática</button>
                    <button class="examen-tab" type="button" onclick="cambiarCategoria('especiales', this)">Especiales</button>
                    <button class="examen-tab" type="button" onclick="cambiarCategoria('otros', this)">Otros</button>
                </div>

                <div id="hematologia" class="examenes-grid"></div>
                <div id="quimica" class="examenes-grid" style="display:none;"></div>
                <div id="hierro" class="examenes-grid" style="display:none;"></div>
                <div id="hepatica" class="examenes-grid" style="display:none;"></div>
                <div id="especiales" class="examenes-grid" style="display:none;"></div>
                <div id="otros" class="examenes-grid" style="display:none;"></div>

                <button type="submit" class="btn btn-primary w-100 mt-4">
                    <i class="fas fa-save"></i> GUARDAR PACIENTE
                </button>
            </form>
        </div>

        <!-- Historial de Exámenes CON COMPARACIÓN LADO A LADO -->
        <div class="examenes-historial-section" id="examenesHistorialSection" style="display:none;">
            <div class="seguimiento-header">
                <h3><i class="fas fa-flask"></i> Historial de Exámenes - <span id="pacienteExamenesNombre"></span></h3>
                <div>
                    <button class="btn btn-info" onclick="cerrarComparacionExamen()" id="btnCerrarComparacion" style="display:none; margin-right:10px;">
                        <i class="fas fa-times"></i> Cerrar Comparación
                    </button>
                    <button class="btn btn-success" onclick="mostrarModalNuevoExamen()">
                        <i class="fas fa-plus-circle"></i> Nuevo Examen
                    </button>
                </div>
            </div>
            
            <!-- Panel de comparación lado a lado -->
            <div id="comparacionExamenPanel" class="comparacion-panel" style="display:none;"></div>
            
            <!-- Grid de exámenes -->
            <div class="examenes-historial-grid" id="examenesHistorialGrid"></div>
        </div>

        <!-- Seguimientos -->
        <div class="seguimiento-section" id="seguimientoSection" style="display:none;">
            <div class="seguimiento-header">
                <h3><i class="fas fa-history"></i> Seguimientos - <span id="pacienteSeguimientoNombre"></span></h3>
                <button class="btn btn-success" onclick="mostrarFormularioSeguimiento()">
                    <i class="fas fa-plus-circle"></i> Nuevo Seguimiento
                </button>
            </div>
            
            <!-- Formulario de seguimiento integrado -->
            <div id="seguimientoFormContainer" style="display: none; margin-bottom: 20px; background: #f8fafc; padding: 20px; border-radius: 12px; border: 2px solid var(--success);">
                <h4 id="seguimientoFormTitulo" style="margin-bottom: 15px; color: var(--success);">
                    <i class="fas fa-notes-medical"></i> Nuevo Seguimiento
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Fecha</label>
                        <input type="date" id="seguimientoFecha" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Tratamiento</label>
                        <input type="text" id="seguimientoTratamiento" placeholder="Cambios en tratamiento" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Evolución</label>
                        <textarea id="seguimientoEvolucion" rows="2" placeholder="Evolución del paciente..." style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px;"></textarea>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Nuevos exámenes</label>
                        <textarea id="seguimientoExamenes" rows="2" placeholder="Resultados..." style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px;"></textarea>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Próxima cita</label>
                        <input type="date" id="seguimientoProximaCita" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px;">
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
                    <button class="btn btn-warning" onclick="ocultarFormularioSeguimiento()">Cancelar</button>
                    <button class="btn btn-success" onclick="guardarSeguimiento()">Guardar</button>
                </div>
            </div>
            
            <div class="seguimiento-grid" id="seguimientoGrid"></div>
        </div>

        <!-- Filtros -->
        <div class="filters-section">
            <div class="seguimiento-header">
                <h3><i class="fas fa-search"></i> Buscar Pacientes</h3>
                <button class="btn btn-warning" onclick="limpiarFiltros()">Limpiar Filtros</button>
            </div>
            <div class="filters-grid">
                <div class="filter-group">
                    <label>Por Nombre</label>
                    <input type="text" id="filtroNombre" placeholder="Nombre..." oninput="filtrarPacientes()">
                </div>
                <div class="filter-group">
                    <label>Por Diagnóstico</label>
                    <input type="text" id="filtroEnfermedad" placeholder="Diagnóstico..." oninput="filtrarPacientes()">
                </div>
                <div class="filter-group">
                    <label>Por Código</label>
                    <input type="text" id="filtroCodigo" placeholder="Código..." oninput="filtrarPacientes()">
                </div>
            </div>
        </div>

        <!-- Tabla de pacientes -->
        <div class="table-container">
            <div class="table-header">
                <h3><i class="fas fa-users"></i> Lista de Pacientes</h3>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Código</th>
                            <th>Nombre</th>
                            <th>Edad</th>
                            <th>Sexo</th>
                            <th>Diagnóstico</th>
                            <th>Tratamiento</th>
                            <th>Próx. Cita</th>
                            <th>Exámenes</th>
                            <th>Seguimientos</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="cuerpoTabla"></tbody>
                </table>
            </div>
            
            <div class="pagination" id="paginacion">
                <button class="pagination-btn" onclick="cambiarPagina('anterior')" id="btnAnterior">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div id="numerosPagina"></div>
                <button class="pagination-btn" onclick="cambiarPagina('siguiente')" id="btnSiguiente">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Modales -->
    <div class="modal" id="modalExamen">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalExamenTitulo"><i class="fas fa-flask"></i> Nuevo Examen</h2>
                <button class="modal-close" onclick="cerrarModalExamen()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Seleccionar Examen</label>
                    <select id="examenSelect">
                        <option value="">-- Seleccione --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Valor</label>
                    <input type="text" id="examenValor" placeholder="Ingrese el valor">
                </div>
                <div class="form-group">
                    <label>Unidad</label>
                    <input type="text" id="examenUnidad" readonly>
                </div>
                <div class="form-group">
                    <label>Fecha</label>
                    <input type="date" id="examenFecha">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning" onclick="cerrarModalExamen()">Cancelar</button>
                <button class="btn btn-success" onclick="guardarExamen()" id="btnGuardarExamen">Guardar</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modalPaciente">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitulo">Detalles del Paciente</h2>
                <button class="modal-close" onclick="cerrarModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer">
                <button class="btn btn-warning" onclick="cerrarModal()">Cerrar</button>
                <button class="btn btn-success" id="modalGuardar" onclick="guardarEdicion()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <div class="toast-icon" id="toastIcon"><i class="fas fa-check-circle"></i></div>
        <div class="toast-content">
            <div class="toast-title" id="toastTitle">Éxito</div>
            <div class="toast-message" id="toastMessage"></div>
        </div>
        <button class="toast-close" onclick="cerrarToast()">&times;</button>
    </div>

    <script>
        // ==================== CONFIGURACIÓN ====================
        const ITEMS_POR_PAGINA = 10;
        let paginaActual = 1;
        let pacientes = [];
        let pacientesFiltrados = [];
        let pacienteActual = null;
        let pacienteEditando = null;
        let indiceSeguimientoEditando = null;
        let indiceExamenEditando = null;
        let examenSeleccionadoId = null;

        // Lista de exámenes
        const examenes = [
            { id: 'hemoglobina', nombre: 'Hemoglobina', categoria: 'hematologia', unidad: 'g/dL' },
            { id: 'leucocitos', nombre: 'Leucocitos', categoria: 'hematologia', unidad: 'x10³/µL' },
            { id: 'neutrofilos', nombre: 'Neutrófilos', categoria: 'hematologia', unidad: '%' },
            { id: 'linfocitos', nombre: 'Linfocitos', categoria: 'hematologia', unidad: '%' },
            { id: 'plaquetas', nombre: 'Plaquetas', categoria: 'hematologia', unidad: 'x10³/µL' },
            { id: 'creatinina', nombre: 'Creatinina', categoria: 'quimica', unidad: 'mg/dL' },
            { id: 'bun', nombre: 'BUN', categoria: 'quimica', unidad: 'mg/dL' },
            { id: 'urea', nombre: 'Urea', categoria: 'quimica', unidad: 'mg/dL' },
            { id: 'ferritina', nombre: 'Ferritina', categoria: 'hierro', unidad: 'ng/mL' },
            { id: 'hierro', nombre: 'Hierro sérico', categoria: 'hierro', unidad: 'µg/dL' },
            { id: 'b12', nombre: 'Vitamina B12', categoria: 'hierro', unidad: 'pg/mL' },
            { id: 'tgo', nombre: 'TGO', categoria: 'hepatica', unidad: 'U/L' },
            { id: 'tgp', nombre: 'TGP', categoria: 'hepatica', unidad: 'U/L' },
            { id: 'bmo', nombre: 'BMO', categoria: 'especiales', unidad: '' },
            { id: 'eritropoyetina', nombre: 'Eritropoyetina', categoria: 'especiales', unidad: 'mU/mL' },
            { id: 'ultrasonido', nombre: 'Ultrasonido', categoria: 'otros', unidad: '' },
            { id: 'tac', nombre: 'TAC', categoria: 'otros', unidad: '' }
        ];

        // ==================== INICIALIZACIÓN ====================
        document.addEventListener('DOMContentLoaded', () => {
            cargarPacientes();
            generarCamposExamenes();
            cargarSelectExamenes();
        });

        function cargarPacientes() {
            const stored = localStorage.getItem('medidata_comparacion_final');
            pacientes = stored ? JSON.parse(stored) : [];
            pacientesFiltrados = [...pacientes];
            actualizarEstadisticas();
            mostrarPacientes();
        }

        function guardarPacientes() {
            localStorage.setItem('medidata_comparacion_final', JSON.stringify(pacientes));
            pacientesFiltrados = [...pacientes];
            actualizarEstadisticas();
            mostrarPacientes();
            if (pacienteActual) {
                mostrarHistorialExamenes();
                mostrarSeguimientos();
            }
        }

        function generarCamposExamenes() {
            const categorias = ['hematologia', 'quimica', 'hierro', 'hepatica', 'especiales', 'otros'];
            
            categorias.forEach(cat => {
                const container = document.getElementById(cat);
                if (!container) return;
                
                const examenesCat = examenes.filter(e => e.categoria === cat);
                let html = '';
                
                examenesCat.forEach(ex => {
                    html += `
                        <div class="examen-item">
                            <label>${ex.nombre} (${ex.unidad})</label>
                            <input type="text" id="examen_${ex.id}" placeholder="Valor">
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            });
        }

        function cargarSelectExamenes() {
            const select = document.getElementById('examenSelect');
            let html = '<option value="">-- Seleccione --</option>';
            
            examenes.forEach(ex => {
                html += `<option value="${ex.id}" data-unidad="${ex.unidad}">${ex.nombre} (${ex.categoria})</option>`;
            });
            
            select.innerHTML = html;
            
            select.addEventListener('change', function() {
                const opt = this.options[this.selectedIndex];
                document.getElementById('examenUnidad').value = opt.dataset.unidad || '';
            });
        }

        // ==================== ESTADÍSTICAS ====================
        function actualizarEstadisticas() {
            document.getElementById('totalPacientes').textContent = pacientes.length;
            
            let hombres = 0, mujeres = 0, sumaEdad = 0;
            pacientes.forEach(p => {
                if (p.sexo === 'Masculino') hombres++;
                else if (p.sexo === 'Femenino') mujeres++;
                sumaEdad += p.edad;
            });
            
            document.getElementById('hombresCount').textContent = hombres;
            document.getElementById('mujeresCount').textContent = mujeres;
            document.getElementById('edadPromedio').textContent = pacientes.length > 0 ? (sumaEdad / pacientes.length).toFixed(1) : 0;
            document.getElementById('filtradosCount').textContent = pacientesFiltrados.length;
        }

        // ==================== PACIENTES ====================
        function generarCodigo() {
            const num = String(pacientes.length + 1).padStart(4, '0');
            const fecha = new Date();
            return `PAC-${fecha.getFullYear().toString().slice(-2)}${String(fecha.getMonth()+1).padStart(2,'0')}${String(fecha.getDate()).padStart(2,'0')}-${num}`;
        }

        function guardarPacienteCompleto() {
            const nombre = document.getElementById('nombre').value.trim();
            const edad = document.getElementById('edad').value;
            const sexo = document.getElementById('sexo').value;
            const enfermedad = document.getElementById('enfermedad').value.trim();

            if (!nombre || !edad || !sexo || !enfermedad) {
                mostrarToast('error', 'Error', 'Complete campos obligatorios');
                return;
            }

            // Recolectar exámenes
            const examenesPaciente = [];
            examenes.forEach(ex => {
                const input = document.getElementById(`examen_${ex.id}`);
                if (input && input.value.trim()) {
                    examenesPaciente.push({
                        id: ex.id,
                        nombre: ex.nombre,
                        categoria: ex.categoria,
                        valor: input.value.trim(),
                        unidad: ex.unidad,
                        fecha: new Date().toLocaleString(),
                        fechaISO: new Date().toISOString(),
                        historial: []
                    });
                }
            });

            const nuevo = {
                codigo: generarCodigo(),
                nombre: nombre,
                edad: parseInt(edad),
                sexo: sexo,
                enfermedad: enfermedad,
                observaciones: document.getElementById('observaciones').value.trim() || 'Sin observaciones',
                telefono: document.getElementById('telefono').value.trim() || 'No especificado',
                tratamiento: {
                    medicamentos: document.getElementById('medicamentos').value.trim() || 'No indicado',
                    duracion: document.getElementById('duracion').value.trim() || 'No especificada',
                    indicaciones: document.getElementById('indicaciones').value.trim() || 'Sin indicaciones',
                    proximaCita: document.getElementById('proximaCita').value || 'No programada'
                },
                examenes: examenesPaciente,
                seguimientos: [],
                fechaRegistro: new Date().toISOString()
            };

            pacientes.unshift(nuevo);
            guardarPacientes();
            limpiarFormulario();
            mostrarToast('success', 'Registrado', `Código: ${nuevo.codigo}`);
        }

        function limpiarFormulario() {
            document.getElementById('nombre').value = '';
            document.getElementById('edad').value = '';
            document.getElementById('sexo').value = '';
            document.getElementById('enfermedad').value = '';
            document.getElementById('observaciones').value = '';
            document.getElementById('telefono').value = '';
            document.getElementById('medicamentos').value = '';
            document.getElementById('duracion').value = '';
            document.getElementById('indicaciones').value = '';
            document.getElementById('proximaCita').value = '';
            
            examenes.forEach(ex => {
                const input = document.getElementById(`examen_${ex.id}`);
                if (input) input.value = '';
            });
        }

        // ==================== FILTROS ====================
        function filtrarPacientes() {
            const fn = document.getElementById('filtroNombre').value.toLowerCase();
            const fe = document.getElementById('filtroEnfermedad').value.toLowerCase();
            const fc = document.getElementById('filtroCodigo').value.toLowerCase();
            
            pacientesFiltrados = pacientes.filter(p => 
                (!fn || p.nombre.toLowerCase().includes(fn)) &&
                (!fe || p.enfermedad.toLowerCase().includes(fe)) &&
                (!fc || p.codigo.toLowerCase().includes(fc))
            );
            
            paginaActual = 1;
            mostrarPacientes();
        }

        function limpiarFiltros() {
            document.getElementById('filtroNombre').value = '';
            document.getElementById('filtroEnfermedad').value = '';
            document.getElementById('filtroCodigo').value = '';
            filtrarPacientes();
        }

        function filtrarTodos() { pacientesFiltrados = [...pacientes]; paginaActual = 1; mostrarPacientes(); }
        function filtrarHombres() { pacientesFiltrados = pacientes.filter(p => p.sexo === 'Masculino'); paginaActual = 1; mostrarPacientes(); }
        function filtrarMujeres() { pacientesFiltrados = pacientes.filter(p => p.sexo === 'Femenino'); paginaActual = 1; mostrarPacientes(); }

        // ==================== TABLA ====================
        function mostrarPacientes() {
            const tbody = document.getElementById('cuerpoTabla');
            const inicio = (paginaActual - 1) * ITEMS_POR_PAGINA;
            
            if (pacientesFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center" style="padding:60px;">No hay pacientes</td></tr>';
                return;
            }
            
            let html = '';
            for (let i = inicio; i < inicio + ITEMS_POR_PAGINA && i < pacientesFiltrados.length; i++) {
                const p = pacientesFiltrados[i];
                const sexoClass = p.sexo === 'Masculino' ? 'sexo-masculino' : (p.sexo === 'Femenino' ? 'sexo-femenino' : 'sexo-otro');
                
                html += `
                    <tr>
                        <td><span class="code-display">${p.codigo}</span></td>
                        <td><strong>${p.nombre}</strong></td>
                        <td>${p.edad} años</td>
                        <td><span class="sexo-badge ${sexoClass}">${p.sexo}</span></td>
                        <td>${p.enfermedad}</td>
                        <td>${p.tratamiento?.medicamentos || 'No indicado'}</td>
                        <td>${p.tratamiento?.proximaCita || 'No programada'}</td>
                        <td>
                            <span class="sexo-badge" style="background:#7c3aed; color:white; cursor:pointer;" onclick="verHistorialExamenes('${p.codigo}')">
                                ${p.examenes?.length || 0} exámenes
                            </span>
                        </td>
                        <td>
                            <span class="sexo-badge" style="background:var(--success); color:white; cursor:pointer;" onclick="verSeguimientos('${p.codigo}')">
                                ${p.seguimientos?.length || 0} seguimientos
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-icon btn-view" onclick="verPaciente('${p.codigo}')" title="Ver"><i class="fas fa-eye"></i></button>
                                <button class="btn-icon btn-edit" onclick="editarPaciente('${p.codigo}')" title="Editar"><i class="fas fa-edit"></i></button>
                                <button class="btn-icon btn-lab" onclick="verHistorialExamenes('${p.codigo}')" title="Exámenes"><i class="fas fa-flask"></i></button>
                                <button class="btn-icon btn-history" onclick="verSeguimientos('${p.codigo}')" title="Seguimientos"><i class="fas fa-history"></i></button>
                                <button class="btn-icon btn-delete" onclick="eliminarPaciente('${p.codigo}')" title="Eliminar"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                `;
            }
            tbody.innerHTML = html;
            actualizarPaginacion();
        }

        function actualizarPaginacion() {
            const total = Math.ceil(pacientesFiltrados.length / ITEMS_POR_PAGINA);
            document.getElementById('btnAnterior').disabled = paginaActual === 1;
            document.getElementById('btnSiguiente').disabled = paginaActual === total;
            
            let html = '';
            for (let i = 1; i <= total; i++) {
                if (i === 1 || i === total || (i >= paginaActual - 2 && i <= paginaActual + 2)) {
                    html += `<button class="pagination-btn ${i === paginaActual ? 'active' : ''}" onclick="irPagina(${i})">${i}</button>`;
                } else if (i === paginaActual - 3 || i === paginaActual + 3) {
                    html += '<span class="pagination-btn" style="border:none;">...</span>';
                }
            }
            document.getElementById('numerosPagina').innerHTML = html;
        }

        function cambiarPagina(dir) {
            const total = Math.ceil(pacientesFiltrados.length / ITEMS_POR_PAGINA);
            if (dir === 'anterior' && paginaActual > 1) paginaActual--;
            else if (dir === 'siguiente' && paginaActual < total) paginaActual++;
            mostrarPacientes();
        }

        function irPagina(pagina) { paginaActual = pagina; mostrarPacientes(); }

        // ==================== CRUD PACIENTES ====================
        function verPaciente(codigo) {
            const p = pacientes.find(p => p.codigo === codigo);
            if (!p) return;
            
            document.getElementById('modalBody').innerHTML = `
                <p><strong>Código:</strong> ${p.codigo}</p>
                <p><strong>Nombre:</strong> ${p.nombre}</p>
                <p><strong>Edad:</strong> ${p.edad} años</p>
                <p><strong>Sexo:</strong> ${p.sexo}</p>
                <p><strong>Diagnóstico:</strong> ${p.enfermedad}</p>
                <p><strong>Tratamiento:</strong> ${p.tratamiento?.medicamentos || 'No indicado'}</p>
                <p><strong>Próxima cita:</strong> ${p.tratamiento?.proximaCita || 'No programada'}</p>
                <p><strong>Exámenes:</strong> ${p.examenes?.length || 0}</p>
                <p><strong>Seguimientos:</strong> ${p.seguimientos?.length || 0}</p>
            `;
            
            document.getElementById('modalTitulo').innerHTML = '<i class="fas fa-user-md"></i> Detalles';
            document.getElementById('modalGuardar').style.display = 'none';
            document.getElementById('modalPaciente').classList.add('active');
        }

        function editarPaciente(codigo) {
            const p = pacientes.find(p => p.codigo === codigo);
            if (!p) return;
            
            pacienteEditando = p;
            
            document.getElementById('modalBody').innerHTML = `
                <div class="form-group"><label>Nombre</label><input type="text" id="editNombre" value="${p.nombre}"></div>
                <div class="form-group"><label>Edad</label><input type="number" id="editEdad" value="${p.edad}"></div>
                <div class="form-group">
                    <label>Sexo</label>
                    <select id="editSexo">
                        <option value="Masculino" ${p.sexo === 'Masculino' ? 'selected' : ''}>Masculino</option>
                        <option value="Femenino" ${p.sexo === 'Femenino' ? 'selected' : ''}>Femenino</option>
                        <option value="Otro" ${p.sexo === 'Otro' ? 'selected' : ''}>Otro</option>
                    </select>
                </div>
                <div class="form-group"><label>Diagnóstico</label><input type="text" id="editEnfermedad" value="${p.enfermedad}"></div>
                <div class="form-group"><label>Teléfono</label><input type="text" id="editTelefono" value="${p.telefono}"></div>
                <h4>Tratamiento</h4>
                <div class="form-group"><label>Medicamentos</label><input type="text" id="editMedicamentos" value="${p.tratamiento?.medicamentos || ''}"></div>
                <div class="form-group"><label>Próxima cita</label><input type="date" id="editProximaCita" value="${p.tratamiento?.proximaCita || ''}"></div>
            `;
            
            document.getElementById('modalTitulo').innerHTML = '<i class="fas fa-edit"></i> Editar';
            document.getElementById('modalGuardar').style.display = 'inline-flex';
            document.getElementById('modalPaciente').classList.add('active');
        }

        function guardarEdicion() {
            if (!pacienteEditando) return;
            
            pacienteEditando.nombre = document.getElementById('editNombre').value;
            pacienteEditando.edad = parseInt(document.getElementById('editEdad').value);
            pacienteEditando.sexo = document.getElementById('editSexo').value;
            pacienteEditando.enfermedad = document.getElementById('editEnfermedad').value;
            pacienteEditando.telefono = document.getElementById('editTelefono').value;
            
            if (!pacienteEditando.tratamiento) pacienteEditando.tratamiento = {};
            pacienteEditando.tratamiento.medicamentos = document.getElementById('editMedicamentos').value;
            pacienteEditando.tratamiento.proximaCita = document.getElementById('editProximaCita').value;
            
            guardarPacientes();
            cerrarModal();
            mostrarToast('success', 'Actualizado', 'Cambios guardados');
        }

        function eliminarPaciente(codigo) {
            if (confirm('¿Eliminar paciente?')) {
                pacientes = pacientes.filter(p => p.codigo !== codigo);
                guardarPacientes();
                mostrarToast('warning', 'Eliminado', 'Registro eliminado');
                
                if (pacienteActual?.codigo === codigo) {
                    pacienteActual = null;
                    document.getElementById('seguimientoSection').style.display = 'none';
                    document.getElementById('examenesHistorialSection').style.display = 'none';
                }
            }
        }

        function cerrarModal() {
            document.getElementById('modalPaciente').classList.remove('active');
            pacienteEditando = null;
        }

        // ==================== EXÁMENES CON COMPARACIÓN CORREGIDA ====================
        function cambiarCategoria(cat, btn) {
            document.querySelectorAll('.examen-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.examenes-grid').forEach(g => g.style.display = 'none');
            btn.classList.add('active');
            document.getElementById(cat).style.display = 'grid';
        }

        function verHistorialExamenes(codigo) {
            pacienteActual = pacientes.find(p => p.codigo === codigo);
            if (!pacienteActual) return;
            
            document.getElementById('pacienteExamenesNombre').textContent = pacienteActual.nombre;
            document.getElementById('examenesHistorialSection').style.display = 'block';
            examenSeleccionadoId = null;
            document.getElementById('btnCerrarComparacion').style.display = 'none';
            document.getElementById('comparacionExamenPanel').style.display = 'none';
            mostrarHistorialExamenes();
        }

        function mostrarHistorialExamenes() {
            if (!pacienteActual) return;
            
            const grid = document.getElementById('examenesHistorialGrid');
            
            if (!pacienteActual.examenes || pacienteActual.examenes.length === 0) {
                grid.innerHTML = '<p class="text-center">No hay exámenes registrados</p>';
                return;
            }
            
            let html = '';
            pacienteActual.examenes.forEach((ex) => {
                const tieneHistorial = ex.historial && ex.historial.length > 0;
                const ultimoCambio = tieneHistorial ? ex.historial[ex.historial.length - 1] : null;
                const seleccionado = examenSeleccionadoId === ex.id;
                
                html += `
                    <div class="examen-card ${seleccionado ? 'selected' : ''}" onclick="seleccionarExamen('${ex.id}')">
                        ${tieneHistorial ? '<span class="examen-historial-indicator"><i class="fas fa-history"></i> ' + ex.historial.length + '</span>' : ''}
                        <div class="examen-card-header">
                            <span class="examen-nombre">${ex.nombre}</span>
                            <span class="examen-categoria">${ex.categoria}</span>
                        </div>
                        <div class="examen-valor-actual">${ex.valor}</div>
                        <div class="examen-unidad">${ex.unidad}</div>
                        <div class="examen-fecha">
                            <i class="far fa-calendar-alt"></i> ${ex.fecha}
                        </div>
                        <div style="display:flex; justify-content:flex-end; gap:5px; margin-top:10px;">
                            <button class="btn-icon-small" style="background:var(--warning);" onclick="event.stopPropagation(); editarExamen('${ex.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon-small" style="background:var(--danger);" onclick="event.stopPropagation(); eliminarExamen('${ex.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }

        function seleccionarExamen(examenId) {
            if (!pacienteActual?.examenes) return;
            
            const examen = pacienteActual.examenes.find(e => e.id === examenId);
            if (!examen) return;
            
            if (examenSeleccionadoId === examenId) {
                examenSeleccionadoId = null;
                document.getElementById('btnCerrarComparacion').style.display = 'none';
                document.getElementById('comparacionExamenPanel').style.display = 'none';
            } else {
                examenSeleccionadoId = examenId;
                mostrarComparacionExamen(examen);
            }
            
            mostrarHistorialExamenes();
        }

        function mostrarComparacionExamen(examen) {
            const panel = document.getElementById('comparacionExamenPanel');
            const historial = examen.historial || [];
            
            if (historial.length === 0) {
                panel.innerHTML = `
                    <div class="comparacion-titulo">
                        <h3><i class="fas fa-info-circle"></i> ${examen.nombre}</h3>
                        <button class="btn-cerrar-comparacion" onclick="cerrarComparacionExamen()">
                            <i class="fas fa-times"></i> Cerrar
                        </button>
                    </div>
                    <div style="text-align: center; padding: 30px; background: white; border-radius: 12px;">
                        <i class="fas fa-flask" style="font-size: 48px; color: var(--gray); margin-bottom: 15px;"></i>
                        <h4>No hay historial de cambios</h4>
                        <p style="color: var(--gray); margin-top: 10px;">Este examen solo tiene el valor actual: <strong>${examen.valor} ${examen.unidad}</strong></p>
                        <p style="color: var(--gray);">Fecha: ${examen.fecha}</p>
                    </div>
                `;
                panel.style.display = 'block';
                document.getElementById('btnCerrarComparacion').style.display = 'inline-flex';
                return;
            }
            
            // Tomar el último cambio del historial
            const ultimoCambio = historial[historial.length - 1];
            const valorAnterior = parseFloat(ultimoCambio.valorAnterior);
            const valorActual = parseFloat(examen.valor);
            const diferencia = valorActual - valorAnterior;
            const porcentaje = ((diferencia / valorAnterior) * 100).toFixed(1);
            
            let historialHTML = '';
            if (historial.length > 1) {
                historialHTML = '<div class="timeline-container"><h4><i class="fas fa-history"></i> Historial completo de cambios</h4>';
                
                // Mostrar todos los cambios en orden cronológico (del más antiguo al más reciente)
                historial.forEach((h, index) => {
                    const cambio = parseFloat(h.valorNuevo) - parseFloat(h.valorAnterior);
                    historialHTML += `
                        <div class="timeline-item">
                            <div class="timeline-fecha">${h.fecha}</div>
                            <div class="timeline-cambio">
                                <div class="timeline-valores">
                                    <span class="timeline-valor-anterior">${h.valorAnterior}</span>
                                    <i class="fas fa-arrow-right" style="color: var(--gray);"></i>
                                    <span class="timeline-valor-nuevo">${h.valorNuevo}</span>
                                    <span class="timeline-cambio-badge ${cambio >= 0 ? 'cambio-up' : 'cambio-down'}">
                                        ${cambio >= 0 ? '+' : ''}${cambio.toFixed(1)}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                historialHTML += '</div>';
            }
            
            panel.innerHTML = `
                <div class="comparacion-titulo">
                    <h3><i class="fas fa-balance-scale"></i> Comparación: ${examen.nombre}</h3>
                    <button class="btn-cerrar-comparacion" onclick="cerrarComparacionExamen()">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                </div>
                
                <div class="comparacion-grid">
                    <!-- Columna anterior -->
                    <div class="comparacion-columna anterior">
                        <div class="comparacion-header">
                            <span class="comparacion-badge badge-anterior">ANTERIOR</span>
                            <span class="comparacion-fecha">${ultimoCambio.fecha}</span>
                        </div>
                        <div class="comparacion-valor">${ultimoCambio.valorAnterior}</div>
                        <div class="comparacion-unidad">${examen.unidad}</div>
                    </div>
                    
                    <!-- Columna nueva -->
                    <div class="comparacion-columna nuevo">
                        <div class="comparacion-header">
                            <span class="comparacion-badge badge-nuevo">ACTUAL</span>
                            <span class="comparacion-fecha">${examen.fecha}</span>
                        </div>
                        <div class="comparacion-valor">${examen.valor}</div>
                        <div class="comparacion-unidad">${examen.unidad}</div>
                    </div>
                </div>
                
                <div class="comparacion-diferencia">
                    <div class="diferencia-label">Diferencia</div>
                    <div class="diferencia-valor ${diferencia >= 0 ? 'diferencia-positiva' : 'diferencia-negativa'}">
                        ${diferencia >= 0 ? '+' : ''}${diferencia.toFixed(1)} ${examen.unidad}
                        <span style="font-size: 16px; margin-left: 10px;">(${porcentaje}%)</span>
                    </div>
                    <div style="margin-top: 8px;">
                        <i class="fas ${diferencia >= 0 ? 'fa-arrow-up' : 'fa-arrow-down'}"></i>
                        ${diferencia >= 0 ? 'Aumentó' : 'Disminuyó'}
                    </div>
                </div>
                
                ${historialHTML}
            `;
            
            panel.style.display = 'block';
            document.getElementById('btnCerrarComparacion').style.display = 'inline-flex';
        }

        function cerrarComparacionExamen() {
            examenSeleccionadoId = null;
            document.getElementById('comparacionExamenPanel').style.display = 'none';
            document.getElementById('btnCerrarComparacion').style.display = 'none';
            mostrarHistorialExamenes();
        }

        function mostrarModalNuevoExamen() {
            document.getElementById('modalExamenTitulo').innerHTML = '<i class="fas fa-flask"></i> Nuevo Examen';
            document.getElementById('examenSelect').value = '';
            document.getElementById('examenValor').value = '';
            document.getElementById('examenFecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('btnGuardarExamen').onclick = guardarNuevoExamen;
            indiceExamenEditando = null;
            document.getElementById('modalExamen').classList.add('active');
        }

        function editarExamen(examenId) {
            if (!pacienteActual?.examenes) return;
            
            const index = pacienteActual.examenes.findIndex(e => e.id === examenId);
            if (index === -1) return;
            
            const ex = pacienteActual.examenes[index];
            indiceExamenEditando = index;
            
            const select = document.getElementById('examenSelect');
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].value === ex.id) {
                    select.selectedIndex = i;
                    break;
                }
            }
            
            document.getElementById('examenValor').value = ex.valor;
            document.getElementById('examenUnidad').value = ex.unidad;
            document.getElementById('examenFecha').value = ex.fechaISO?.split('T')[0] || new Date().toISOString().split('T')[0];
            
            document.getElementById('modalExamenTitulo').innerHTML = '<i class="fas fa-edit"></i> Editar Examen';
            document.getElementById('btnGuardarExamen').onclick = guardarEdicionExamen;
            document.getElementById('modalExamen').classList.add('active');
        }

        function guardarNuevoExamen() {
            if (!pacienteActual) return;
            
            const select = document.getElementById('examenSelect');
            const examenId = select.value;
            if (!examenId) { mostrarToast('warning', 'Seleccione examen'); return; }
            
            const valor = document.getElementById('examenValor').value.trim();
            if (!valor) { mostrarToast('warning', 'Ingrese valor'); return; }
            
            const opt = select.options[select.selectedIndex];
            const nombre = opt.text.split(' (')[0];
            const unidad = opt.dataset.unidad;
            
            // Buscar si ya existe
            const existente = pacienteActual.examenes?.find(e => e.id === examenId);
            
            if (existente) {
                if (!existente.historial) existente.historial = [];
                existente.historial.push({
                    fecha: new Date().toLocaleString(),
                    valorAnterior: existente.valor,
                    valorNuevo: valor
                });
                existente.valor = valor;
                existente.fecha = new Date().toLocaleString();
                existente.fechaISO = new Date().toISOString();
                mostrarToast('info', 'Examen actualizado');
            } else {
                if (!pacienteActual.examenes) pacienteActual.examenes = [];
                pacienteActual.examenes.push({
                    id: examenId,
                    nombre: nombre,
                    categoria: examenes.find(e => e.id === examenId)?.categoria || '',
                    valor: valor,
                    unidad: unidad,
                    fecha: new Date().toLocaleString(),
                    fechaISO: new Date().toISOString(),
                    historial: []
                });
                mostrarToast('success', 'Examen agregado');
            }
            
            guardarPacientes();
            cerrarModalExamen();
            mostrarHistorialExamenes();
            cerrarComparacionExamen();
        }

        function guardarEdicionExamen() {
            if (!pacienteActual || indiceExamenEditando === null) return;
            
            const examen = pacienteActual.examenes[indiceExamenEditando];
            const valor = document.getElementById('examenValor').value.trim();
            
            if (!valor) { mostrarToast('warning', 'Ingrese valor'); return; }
            
            if (!examen.historial) examen.historial = [];
            examen.historial.push({
                fecha: new Date().toLocaleString(),
                valorAnterior: examen.valor,
                valorNuevo: valor
            });
            
            examen.valor = valor;
            examen.fecha = new Date().toLocaleString();
            examen.fechaISO = new Date().toISOString();
            
            guardarPacientes();
            cerrarModalExamen();
            mostrarHistorialExamenes();
            cerrarComparacionExamen();
            mostrarToast('success', 'Examen actualizado');
        }

        function eliminarExamen(examenId) {
            if (!pacienteActual?.examenes) return;
            if (confirm('¿Eliminar examen?')) {
                pacienteActual.examenes = pacienteActual.examenes.filter(e => e.id !== examenId);
                guardarPacientes();
                mostrarHistorialExamenes();
                if (examenSeleccionadoId === examenId) {
                    cerrarComparacionExamen();
                }
                mostrarToast('warning', 'Examen eliminado');
            }
        }

        function cerrarModalExamen() {
            document.getElementById('modalExamen').classList.remove('active');
            indiceExamenEditando = null;
        }

        // ==================== SEGUIMIENTOS ====================
        function mostrarFormularioSeguimiento() {
            document.getElementById('seguimientoFormContainer').style.display = 'block';
            document.getElementById('seguimientoFecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('seguimientoTratamiento').value = '';
            document.getElementById('seguimientoEvolucion').value = '';
            document.getElementById('seguimientoExamenes').value = '';
            document.getElementById('seguimientoProximaCita').value = '';
            document.getElementById('seguimientoFormTitulo').innerHTML = '<i class="fas fa-plus-circle"></i> Nuevo Seguimiento';
            indiceSeguimientoEditando = null;
        }

        function ocultarFormularioSeguimiento() {
            document.getElementById('seguimientoFormContainer').style.display = 'none';
        }

        function verSeguimientos(codigo) {
            pacienteActual = pacientes.find(p => p.codigo === codigo);
            if (!pacienteActual) return;
            
            document.getElementById('pacienteSeguimientoNombre').textContent = pacienteActual.nombre;
            document.getElementById('seguimientoSection').style.display = 'block';
            ocultarFormularioSeguimiento();
            mostrarSeguimientos();
        }

        function mostrarSeguimientos() {
            if (!pacienteActual) return;
            
            const grid = document.getElementById('seguimientoGrid');
            
            if (!pacienteActual.seguimientos || pacienteActual.seguimientos.length === 0) {
                grid.innerHTML = '<p class="text-center">No hay seguimientos</p>';
                return;
            }
            
            // Ordenar por fecha descendente
            const seguimientos = [...pacienteActual.seguimientos].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            let html = '';
            for (let i = 0; i < seguimientos.length; i++) {
                const s = seguimientos[i];
                const anterior = i < seguimientos.length - 1 ? seguimientos[i + 1] : null;
                
                html += `
                    <div class="seguimiento-card ${i === 0 ? 'nuevo' : ''}">
                        <div style="display:flex; justify-content:space-between;">
                            <span class="seguimiento-fecha"><i class="far fa-calendar-alt"></i> ${s.fecha}</span>
                            <div>
                                <button class="btn-icon-small" style="background:var(--warning);" onclick="editarSeguimiento(${pacienteActual.seguimientos.indexOf(s)})"><i class="fas fa-edit"></i></button>
                                <button class="btn-icon-small" style="background:var(--danger);" onclick="eliminarSeguimiento(${pacienteActual.seguimientos.indexOf(s)})"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        
                        <div class="seguimiento-tratamiento"><i class="fas fa-pills"></i> ${s.tratamiento}</div>
                        <div class="seguimiento-evolucion"><i class="fas fa-chart-line"></i> ${s.evolucion}</div>
                        ${s.examenes ? `<div><i class="fas fa-flask"></i> ${s.examenes}</div>` : ''}
                        ${s.proximaCita ? `<div><i class="fas fa-calendar-check"></i> Próxima: ${s.proximaCita}</div>` : ''}
                        
                        ${anterior ? generarComparacionSeguimientos(s, anterior) : ''}
                    </div>
                `;
            }
            
            grid.innerHTML = html;
        }

        function generarComparacionSeguimientos(nuevo, anterior) {
            let cambios = [];
            let html = '<div class="comparacion-container">';
            
            if (nuevo.tratamiento !== anterior.tratamiento) {
                cambios.push('tratamiento');
                html += `
                    <div class="cambio-item">
                        <div class="cambio-label">Tratamiento</div>
                        <div class="cambio-valores">
                            <span class="valor-anterior">${anterior.tratamiento}</span>
                            <i class="fas fa-arrow-right"></i>
                            <span class="valor-nuevo">${nuevo.tratamiento}</span>
                        </div>
                    </div>
                `;
            }
            
            if (nuevo.evolucion !== anterior.evolucion) {
                cambios.push('evolución');
                html += `
                    <div class="cambio-item">
                        <div class="cambio-label">Evolución</div>
                        <div class="cambio-valores">
                            <span class="valor-anterior">${anterior.evolucion.substring(0,30)}...</span>
                            <i class="fas fa-arrow-right"></i>
                            <span class="valor-nuevo">${nuevo.evolucion.substring(0,30)}...</span>
                        </div>
                    </div>
                `;
            }
            
            if (nuevo.examenes !== anterior.examenes) {
                cambios.push('exámenes');
            }
            
            if (nuevo.proximaCita !== anterior.proximaCita) {
                cambios.push('próxima cita');
            }
            
            if (cambios.length > 0) {
                html += `<span class="badge-cambios">${cambios.length} cambio${cambios.length > 1 ? 's' : ''}</span>`;
            }
            
            html += '</div>';
            return html;
        }

        function editarSeguimiento(index) {
            if (!pacienteActual?.seguimientos?.[index]) return;
            
            const s = pacienteActual.seguimientos[index];
            indiceSeguimientoEditando = index;
            
            document.getElementById('seguimientoFecha').value = s.fecha;
            document.getElementById('seguimientoTratamiento').value = s.tratamiento;
            document.getElementById('seguimientoEvolucion').value = s.evolucion;
            document.getElementById('seguimientoExamenes').value = s.examenes || '';
            document.getElementById('seguimientoProximaCita').value = s.proximaCita || '';
            
            document.getElementById('seguimientoFormTitulo').innerHTML = '<i class="fas fa-edit"></i> Editar Seguimiento';
            document.getElementById('seguimientoFormContainer').style.display = 'block';
        }

        function eliminarSeguimiento(index) {
            if (!pacienteActual?.seguimientos) return;
            if (confirm('¿Eliminar seguimiento?')) {
                pacienteActual.seguimientos.splice(index, 1);
                guardarPacientes();
                mostrarSeguimientos();
                mostrarToast('warning', 'Seguimiento eliminado');
            }
        }

        function guardarSeguimiento() {
            if (!pacienteActual) return;
            
            const fecha = document.getElementById('seguimientoFecha').value;
            if (!fecha) { mostrarToast('warning', 'Fecha requerida'); return; }
            
            const nuevo = {
                fecha: fecha,
                tratamiento: document.getElementById('seguimientoTratamiento').value || 'Sin cambios',
                evolucion: document.getElementById('seguimientoEvolucion').value || 'Sin evolución',
                examenes: document.getElementById('seguimientoExamenes').value || null,
                proximaCita: document.getElementById('seguimientoProximaCita').value || null,
                fechaRegistro: new Date().toLocaleString()
            };
            
            if (indiceSeguimientoEditando !== null) {
                pacienteActual.seguimientos[indiceSeguimientoEditando] = nuevo;
                mostrarToast('success', 'Seguimiento actualizado');
            } else {
                if (!pacienteActual.seguimientos) pacienteActual.seguimientos = [];
                pacienteActual.seguimientos.push(nuevo);
                mostrarToast('success', 'Seguimiento guardado');
            }
            
            // Actualizar tratamiento principal
            if (nuevo.tratamiento !== 'Sin cambios') {
                if (!pacienteActual.tratamiento) pacienteActual.tratamiento = {};
                pacienteActual.tratamiento.medicamentos = nuevo.tratamiento;
            }
            if (nuevo.proximaCita) {
                if (!pacienteActual.tratamiento) pacienteActual.tratamiento = {};
                pacienteActual.tratamiento.proximaCita = nuevo.proximaCita;
            }
            
            guardarPacientes();
            ocultarFormularioSeguimiento();
            mostrarSeguimientos();
        }

        // ==================== EXCEL ====================
        function exportarExcelCompleto() {
            if (pacientes.length === 0) { mostrarToast('warning', 'Sin datos'); return; }
            
            const datos = pacientes.map(p => ({
                Código: p.codigo,
                Nombre: p.nombre,
                Edad: p.edad,
                Sexo: p.sexo,
                Diagnóstico: p.enfermedad,
                Tratamiento: p.tratamiento?.medicamentos || '',
                'Próxima Cita': p.tratamiento?.proximaCita || '',
                '# Exámenes': p.examenes?.length || 0,
                '# Seguimientos': p.seguimientos?.length || 0
            }));
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(datos);
            XLSX.utils.book_append_sheet(wb, ws, "Pacientes");
            XLSX.writeFile(wb, `pacientes_${new Date().toISOString().slice(0,10)}.xlsx`);
            mostrarToast('success', `Exportados ${pacientes.length} pacientes`);
        }

        function exportarExcelFiltrado() {
            if (pacientesFiltrados.length === 0) { mostrarToast('warning', 'Sin datos'); return; }
            
            const datos = pacientesFiltrados.map(p => ({
                Código: p.codigo,
                Nombre: p.nombre,
                Edad: p.edad,
                Sexo: p.sexo,
                Diagnóstico: p.enfermedad
            }));
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(datos);
            XLSX.utils.book_append_sheet(wb, ws, "Filtrados");
            XLSX.writeFile(wb, `filtrados_${new Date().toISOString().slice(0,10)}.xlsx`);
            mostrarToast('success', `Exportados ${pacientesFiltrados.length} registros`);
        }

        function exportarExcelResumen() {
            const hombres = pacientes.filter(p => p.sexo === 'Masculino').length;
            const mujeres = pacientes.filter(p => p.sexo === 'Femenino').length;
            const edadProm = pacientes.reduce((a, c) => a + c.edad, 0) / pacientes.length || 0;
            
            const datos = [
                { Métrica: 'Total Pacientes', Valor: pacientes.length },
                { Métrica: 'Hombres', Valor: hombres },
                { Métrica: 'Mujeres', Valor: mujeres },
                { Métrica: 'Edad Promedio', Valor: edadProm.toFixed(1) }
            ];
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(datos);
            XLSX.utils.book_append_sheet(wb, ws, "Resumen");
            XLSX.writeFile(wb, `resumen_${new Date().toISOString().slice(0,10)}.xlsx`);
            mostrarToast('success', 'Resumen exportado');
        }

        function exportarExcelExamenes() {
            if (!pacienteActual || !pacienteActual.examenes?.length) {
                mostrarToast('warning', 'Seleccione paciente con exámenes');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(pacienteActual.examenes);
            XLSX.utils.book_append_sheet(wb, ws, "Exámenes");
            XLSX.writeFile(wb, `examenes_${pacienteActual.nombre}_${new Date().toISOString().slice(0,10)}.xlsx`);
            mostrarToast('success', 'Exámenes exportados');
        }

        // ==================== TOAST ====================
        function mostrarToast(tipo, mensaje, detalle = '') {
            const toast = document.getElementById('toast');
            document.getElementById('toastTitle').textContent = tipo === 'success' ? 'Éxito' : tipo === 'error' ? 'Error' : 'Aviso';
            document.getElementById('toastMessage').textContent = mensaje + (detalle ? ': ' + detalle : '');
            toast.className = 'toast ' + tipo;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function cerrarToast() {
            document.getElementById('toast').classList.remove('show');
        }

        // Exponer funciones globales
        window.filtrarTodos = filtrarTodos;
        window.filtrarHombres = filtrarHombres;
        window.filtrarMujeres = filtrarMujeres;
        window.exportarExcelCompleto = exportarExcelCompleto;
        window.exportarExcelFiltrado = exportarExcelFiltrado;
        window.exportarExcelResumen = exportarExcelResumen;
        window.exportarExcelExamenes = exportarExcelExamenes;
        window.cambiarCategoria = cambiarCategoria;
        window.guardarPacienteCompleto = guardarPacienteCompleto;
        window.verHistorialExamenes = verHistorialExamenes;
        window.verSeguimientos = verSeguimientos;
        window.mostrarModalNuevoExamen = mostrarModalNuevoExamen;
        window.editarExamen = editarExamen;
        window.eliminarExamen = eliminarExamen;
        window.cerrarModalExamen = cerrarModalExamen;
        window.guardarExamen = guardarNuevoExamen;
        window.seleccionarExamen = seleccionarExamen;
        window.cerrarComparacionExamen = cerrarComparacionExamen;
        window.mostrarFormularioSeguimiento = mostrarFormularioSeguimiento;
        window.ocultarFormularioSeguimiento = ocultarFormularioSeguimiento;
        window.editarSeguimiento = editarSeguimiento;
        window.eliminarSeguimiento = eliminarSeguimiento;
        window.guardarSeguimiento = guardarSeguimiento;
        window.filtrarPacientes = filtrarPacientes;
        window.limpiarFiltros = limpiarFiltros;
        window.verPaciente = verPaciente;
        window.editarPaciente = editarPaciente;
        window.eliminarPaciente = eliminarPaciente;
        window.guardarEdicion = guardarEdicion;
        window.cerrarModal = cerrarModal;
        window.cambiarPagina = cambiarPagina;
        window.irPagina = irPagina;
        window.cerrarToast = cerrarToast;
    </script>
</body>
</html>
